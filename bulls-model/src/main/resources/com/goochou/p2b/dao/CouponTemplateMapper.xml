<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goochou.p2b.dao.CouponTemplateMapper">
  <resultMap id="BaseResultMap" type="com.goochou.p2b.model.CouponTemplate">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 25 16:43:52 CST 2018.
    -->
      <id column="template_id" jdbcType="VARCHAR" property="templateId"/>
      <result column="title" jdbcType="VARCHAR" property="title"/>
      <result column="type" jdbcType="INTEGER" property="type"/>
      <result column="amount" jdbcType="DECIMAL" property="amount"/>
      <result column="rate" jdbcType="DECIMAL" property="rate"/>
      <result column="min_amount" jdbcType="DECIMAL" property="minAmount"/>
      <result column="min_days" jdbcType="INTEGER" property="minDays"/>
      <result column="effective_days" jdbcType="INTEGER" property="effectiveDays"/>
      <result column="stock_limit" jdbcType="INTEGER" property="stockLimit"/>
      <result column="stock_balance" jdbcType="INTEGER" property="stockBalance"/>
      <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
      <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
      <result column="version" jdbcType="INTEGER" property="version"/>
      <result column="is_deleted" jdbcType="INTEGER" property="isDeleted"/>
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 25 16:43:52 CST 2018.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        template_id, title, type, amount, rate, min_amount, min_days, effective_days, stock_limit,
        stock_balance, create_time, update_time, version, is_deleted
    </sql>
    <select id="selectByExample" parameterType="com.goochou.p2b.model.CouponTemplateExample" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="Base_Column_List"/>
        from coupon_template
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
        <if test="limitStart != null and limitStart&gt;-1">
            limit ${limitStart} , ${limitEnd}
        </if>
    </select>
    <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        select
        <include refid="Base_Column_List"/>
        from coupon_template
        where template_id = #{templateId,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        delete from coupon_template
        where template_id = #{templateId,jdbcType=VARCHAR}
    </delete>
    <delete id="deleteByExample" parameterType="com.goochou.p2b.model.CouponTemplateExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        delete from coupon_template
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </delete>
    <insert id="insert" parameterType="com.goochou.p2b.model.CouponTemplate">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        insert into coupon_template (template_id, title, type,
        amount, rate, min_amount,
        min_days, effective_days, stock_limit,
        stock_balance, create_time, update_time,
        version, is_deleted)
        values (UUID(), #{title,jdbcType=VARCHAR}, #{type,jdbcType=INTEGER},
        #{amount,jdbcType=DECIMAL}, #{rate,jdbcType=DECIMAL}, #{minAmount,jdbcType=DECIMAL},
        #{minDays,jdbcType=INTEGER}, #{effectiveDays,jdbcType=INTEGER}, #{stockLimit,jdbcType=INTEGER},
        #{stockBalance,jdbcType=INTEGER}, NOW(), NOW(), 0, 1)
    </insert>
    <insert id="insertSelective" parameterType="com.goochou.p2b.model.CouponTemplate">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        insert into coupon_template
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="templateId != null">
                template_id,
            </if>
            <if test="title != null">
                title,
            </if>
            <if test="type != null">
                type,
            </if>
            <if test="amount != null">
                amount,
            </if>
            <if test="rate != null">
                rate,
            </if>
            <if test="minAmount != null">
                min_amount,
            </if>
            <if test="minDays != null">
                min_days,
            </if>
            <if test="effectiveDays != null">
                effective_days,
            </if>
            <if test="stockLimit != null">
                stock_limit,
            </if>
            <if test="stockBalance != null">
                stock_balance,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="version != null">
                version,
            </if>
            <if test="isDeleted != null">
                is_deleted,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="templateId != null">
                #{templateId,jdbcType=VARCHAR},
            </if>
            <if test="title != null">
                #{title,jdbcType=VARCHAR},
            </if>
            <if test="type != null">
                #{type,jdbcType=INTEGER},
            </if>
            <if test="amount != null">
                #{amount,jdbcType=DECIMAL},
            </if>
            <if test="rate != null">
                #{rate,jdbcType=DECIMAL},
            </if>
            <if test="minAmount != null">
                #{minAmount,jdbcType=DECIMAL},
            </if>
            <if test="minDays != null">
                #{minDays,jdbcType=INTEGER},
            </if>
            <if test="effectiveDays != null">
                #{effectiveDays,jdbcType=INTEGER},
            </if>
            <if test="stockLimit != null">
                #{stockLimit,jdbcType=INTEGER},
            </if>
            <if test="stockBalance != null">
                #{stockBalance,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="version != null">
                #{version,jdbcType=INTEGER},
            </if>
            <if test="isDeleted != null">
                #{isDeleted,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <select id="countByExample" parameterType="com.goochou.p2b.model.CouponTemplateExample" resultType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        select count(*) from coupon_template
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>
    <update id="updateByExampleSelective" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        update coupon_template
        <set>
            <if test="record.templateId != null">
                template_id = #{record.templateId,jdbcType=VARCHAR},
            </if>
            <if test="record.title != null">
                title = #{record.title,jdbcType=VARCHAR},
            </if>
            <if test="record.type != null">
                type = #{record.type,jdbcType=INTEGER},
            </if>
            <if test="record.amount != null">
                amount = #{record.amount,jdbcType=DECIMAL},
            </if>
            <if test="record.rate != null">
                rate = #{record.rate,jdbcType=DECIMAL},
            </if>
            <if test="record.minAmount != null">
                min_amount = #{record.minAmount,jdbcType=DECIMAL},
            </if>
            <if test="record.minDays != null">
                min_days = #{record.minDays,jdbcType=INTEGER},
            </if>
            <if test="record.effectiveDays != null">
                effective_days = #{record.effectiveDays,jdbcType=INTEGER},
            </if>
            <if test="record.stockLimit != null">
                stock_limit = #{record.stockLimit,jdbcType=INTEGER},
            </if>
            <if test="record.stockBalance != null">
                stock_balance = #{record.stockBalance,jdbcType=INTEGER},
            </if>
            <if test="record.createTime != null">
                create_time = #{record.createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.updateTime != null">
                update_time = #{record.updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.version != null">
                version = #{record.version,jdbcType=INTEGER},
            </if>
            <if test="record.isDeleted != null">
                is_deleted = #{record.isDeleted,jdbcType=INTEGER},
            </if>
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        update coupon_template
        set template_id = #{record.templateId,jdbcType=VARCHAR},
        title = #{record.title,jdbcType=VARCHAR},
        type = #{record.type,jdbcType=INTEGER},
        amount = #{record.amount,jdbcType=DECIMAL},
        rate = #{record.rate,jdbcType=DECIMAL},
        min_amount = #{record.minAmount,jdbcType=DECIMAL},
        min_days = #{record.minDays,jdbcType=INTEGER},
        effective_days = #{record.effectiveDays,jdbcType=INTEGER},
        stock_limit = #{record.stockLimit,jdbcType=INTEGER},
        stock_balance = #{record.stockBalance,jdbcType=INTEGER},
        create_time = #{record.createTime,jdbcType=TIMESTAMP},
        update_time = #{record.updateTime,jdbcType=TIMESTAMP},
        version = #{record.version,jdbcType=INTEGER},
        is_deleted = #{record.isDeleted,jdbcType=INTEGER}
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.CouponTemplate">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        update coupon_template
        <set>
            <if test="title != null">
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="type != null">
                type = #{type,jdbcType=INTEGER},
            </if>
            <if test="amount != null">
                amount = #{amount,jdbcType=DECIMAL},
            </if>
            <if test="rate != null">
                rate = #{rate,jdbcType=DECIMAL},
            </if>
            <if test="minAmount != null">
                min_amount = #{minAmount,jdbcType=DECIMAL},
            </if>
            <if test="minDays != null">
                min_days = #{minDays,jdbcType=INTEGER},
            </if>
            <if test="effectiveDays != null">
                effective_days = #{effectiveDays,jdbcType=INTEGER},
            </if>
            <if test="stockLimit != null">
                stock_limit = #{stockLimit,jdbcType=INTEGER},
            </if>
            <if test="stockBalance != null">
                stock_balance = #{stockBalance,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="version != null">
                version = #{version,jdbcType=INTEGER},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=INTEGER},
            </if>
        </set>
        where template_id = #{templateId,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKeySelectiveAndVersion" parameterType="com.goochou.p2b.model.CouponTemplate">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        update coupon_template
        <set>
            version = version + 1,
            <if test="title != null">
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="type != null">
                type = #{type,jdbcType=INTEGER},
            </if>
            <if test="amount != null">
                amount = #{amount,jdbcType=DECIMAL},
            </if>
            <if test="rate != null">
                rate = #{rate,jdbcType=DECIMAL},
            </if>
            <if test="minAmount != null">
                min_amount = #{minAmount,jdbcType=DECIMAL},
            </if>
            <if test="minDays != null">
                min_days = #{minDays,jdbcType=INTEGER},
            </if>
            <if test="effectiveDays != null">
                effective_days = #{effectiveDays,jdbcType=INTEGER},
            </if>
            <if test="stockLimit != null">
                stock_limit = #{stockLimit,jdbcType=INTEGER},
            </if>
            <if test="stockBalance != null">
                stock_balance = #{stockBalance,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=INTEGER},
            </if>
        </set>
        where template_id = #{templateId,jdbcType=VARCHAR} and version = #{version,jdbcType=INTEGER}
    </update>

    <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.CouponTemplate">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jun 25 16:43:52 CST 2018.
        -->
        update coupon_template
        set title = #{title,jdbcType=VARCHAR},
        type = #{type,jdbcType=INTEGER},
        amount = #{amount,jdbcType=DECIMAL},
        rate = #{rate,jdbcType=DECIMAL},
        min_amount = #{minAmount,jdbcType=DECIMAL},
        min_days = #{minDays,jdbcType=INTEGER},
        effective_days = #{effectiveDays,jdbcType=INTEGER},
        stock_limit = #{stockLimit,jdbcType=INTEGER},
        stock_balance = #{stockBalance,jdbcType=INTEGER},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        update_time = #{updateTime,jdbcType=TIMESTAMP},
        version = #{version,jdbcType=INTEGER},
        is_deleted = #{isDeleted,jdbcType=INTEGER}
        where template_id = #{templateId,jdbcType=VARCHAR}
    </update>

    <select id="couponTemplateList" parameterType="map" resultMap="BaseResultMap">
  	SELECT <include refid="Base_Column_List" /> FROM coupon_template
  		WHERE 1 = 1
	    <if test="type != null and type != ''">
	      AND type = #{type,jdbcType=INTEGER}
	    </if>
	    <if test="keyword != null and keyword != ''">
	      (AND amount = #{keyword,jdbcType=DECIMAL} OR rate = #{keyword,jdbcType=DECIMAL})
	    </if>
	    <if test="minAmount != null and minAmount != ''">
	      AND min_amount = #{minAmount,jdbcType=DECIMAL}
	    </if>
	    <if test="minDays != null and minDays != ''">
	      AND min_days = #{minDays,jdbcType=INTEGER}
	    </if>
	    <if test="stockBalance != null and stockBalance != ''">
	      AND stock_balance &lt;= #{stockBalance,jdbcType=INTEGER}
	    </if>
	    AND is_deleted = 1
  </select>

    <select id="couponTemplateCount" parameterType="map" resultType="int">
  	SELECT COUNT(1) FROM coupon_template
  		WHERE 1 = 1
	    <if test="type != null and type != ''">
	      AND type = #{type,jdbcType=INTEGER}
	    </if>
	    <if test="keyword != null and keyword != ''">
	      (AND amount = #{keyword,jdbcType=DECIMAL} OR rate = #{keyword,jdbcType=DECIMAL})
	    </if>
	    <if test="minAmount != null and minAmount != ''">
	      AND min_amount = #{minAmount,jdbcType=DECIMAL}
	    </if>
	    <if test="minDays != null and minDays != ''">
	      AND min_days = #{minDays,jdbcType=INTEGER}
	    </if>
	    <if test="stockBalance != null and stockBalance != ''">
	      AND stock_balance &lt;= #{stockBalance,jdbcType=INTEGER}
	    </if>
	    AND is_deleted = 1
  </select>


    <select id="getCouponListPage" parameterType="map" resultMap="BaseResultMap">
        SELECT ct.*
        <if test="userId != null">
            ,CASE WHEN h.coupon_id IS NOT NULL THEN 1
            WHEN ct.stock_balance &lt;=0 THEN 2
            ELSE 0
            END STATUS
        </if>
        FROM coupon_template ct
        <if test="userId != null">
            <if test="type == 0">
                LEFT JOIN (SELECT * FROM hongbao WHERE user_id=#{userId} AND expire_time>NOW() AND use_time IS NULL)h ON ct.template_id = h.coupon_id
            </if>
            <if test="type == 1">
                LEFT JOIN (SELECT * FROM rate_coupon WHERE user_id=#{userId} AND status=1 AND expire_time>NOW() AND use_time IS NULL)h ON ct.template_id = h.coupon_id
            </if>
            <if test="type == 2">
                LEFT JOIN (SELECT * FROM hongbao WHERE user_id=#{userId})h ON ct.template_id = h.coupon_id
            </if>
        </if>
        WHERE is_deleted=1
        AND ct.type = #{type,jdbcType=INTEGER}
        <if test="amount != null">
            AND min_amount = #{amount,jdbcType=DECIMAL}
        </if>
        <if test="days != null">
            AND min_days = #{days,jdbcType=INTEGER}
        </if>
        <if test="type == 0">
            ORDER BY IF(ct.stock_balance!=0,ct.amount,NULL) DESC,
        </if>
        <if test="type == 1">
            ORDER BY IF(ct.stock_balance!=0,ct.rate,NULL) DESC,
        </if>
        <if test="type == 2">
            ORDER BY IF(ct.stock_balance!=0,ct.amount,NULL) DESC,
        </if>
        IF(ct.stock_balance=0,ct.update_time,NULL) DESC,
        (ct.stock_limit-ct.stock_balance)/ct.stock_limit DESC
        <if test="start != null and limit != null">
            limit #{start}, #{limit}
        </if>
    </select>

    <select id="getCouponCountPage" parameterType="map" resultType="int">
        SELECT COUNT(1) FROM coupon_template
        WHERE is_deleted = 1
        AND type = #{type,jdbcType=INTEGER}
        <if test="amount != null">
            AND min_amount = #{amount,jdbcType=DECIMAL}
        </if>
        <if test="days != null">
            AND min_days = #{days,jdbcType=INTEGER}
        </if>
        ORDER BY stock_balance DESC,amount DESC,rate DESC ,stock_balance/stock_limit DESC
    </select>


    <select id="getTemplateByCoupon" parameterType="map" resultType="int">
        <if test="type == 0">
            SELECT count(1) FROM hongbao WHERE user_id=#{userId} AND expire_time>NOW() AND use_time IS NULL AND coupon_id =#{id}
        </if>
        <if test="type == 1">
            SELECT count(1) FROM rate_coupon WHERE user_id=#{userId} AND expire_time>NOW() AND use_time IS NULL AND STATUS=1 AND coupon_id =#{id}
        </if>
        <if test="type == 2">
            SELECT count(1) FROM hongbao WHERE user_id=#{userId} AND coupon_id =#{id}
        </if>
    </select>

</mapper>