<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goochou.p2b.dao.WxActivityMapper">
    <resultMap id="BaseResultMap" type="com.goochou.p2b.model.WxActivity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        <id column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="code" jdbcType="VARCHAR" property="code"/>
        <result column="imei" jdbcType="VARCHAR" property="imei"/>
        <result column="leID" jdbcType="INTEGER" property="leid"/>
        <result column="adID" jdbcType="INTEGER" property="adid"/>
    </resultMap>
    <sql id="Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        <where>
            <foreach collection="oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="("
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="("
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        user_id, code, imei, leID, adID
    </sql>
    <select id="selectByExample" parameterType="com.goochou.p2b.model.WxActivityExample" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="Base_Column_List"/>
        from wx_activity
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
        <if test="limitStart != null and limitStart&gt;-1">
            limit ${limitStart} , ${limitEnd}
        </if>
    </select>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        select
        <include refid="Base_Column_List"/>
        from wx_activity
        where user_id = #{userId,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        DELETE FROM wx_activity
        WHERE user_id = #{userId,jdbcType=INTEGER}
    </delete>
    <delete id="deleteByExample" parameterType="com.goochou.p2b.model.WxActivityExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        delete from wx_activity
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </delete>
    <insert id="insert" parameterType="com.goochou.p2b.model.WxActivity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        INSERT INTO wx_activity (user_id, code, imei,
        leID, adID, params)
        VALUES (#{userId,jdbcType=INTEGER}, #{code,jdbcType=VARCHAR}, #{imei,jdbcType=VARCHAR},
        #{leid,jdbcType=INTEGER}, #{adid,jdbcType=INTEGER}, #{params,jdbcType=VARCHAR})
    </insert>
    <insert id="insertSelective" parameterType="com.goochou.p2b.model.WxActivity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        insert into wx_activity
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                user_id,
            </if>
            <if test="code != null">
                code,
            </if>
            <if test="imei != null">
                imei,
            </if>
            <if test="leid != null">
                leID,
            </if>
            <if test="adid != null">
                adID,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">
                #{userId,jdbcType=INTEGER},
            </if>
            <if test="code != null">
                #{code,jdbcType=VARCHAR},
            </if>
            <if test="imei != null">
                #{imei,jdbcType=VARCHAR},
            </if>
            <if test="leid != null">
                #{leid,jdbcType=INTEGER},
            </if>
            <if test="adid != null">
                #{adid,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <select id="countByExample" parameterType="com.goochou.p2b.model.WxActivityExample" resultType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        select count(*) from wx_activity
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>
    <update id="updateByExampleSelective" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        update wx_activity
        <set>
            <if test="record.userId != null">
                user_id = #{record.userId,jdbcType=INTEGER},
            </if>
            <if test="record.code != null">
                code = #{record.code,jdbcType=VARCHAR},
            </if>
            <if test="record.imei != null">
                imei = #{record.imei,jdbcType=VARCHAR},
            </if>
            <if test="record.leid != null">
                leID = #{record.leid,jdbcType=INTEGER},
            </if>
            <if test="record.adid != null">
                adID = #{record.adid,jdbcType=INTEGER},
            </if>
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        update wx_activity
        set user_id = #{record.userId,jdbcType=INTEGER},
        code = #{record.code,jdbcType=VARCHAR},
        imei = #{record.imei,jdbcType=VARCHAR},
        leID = #{record.leid,jdbcType=INTEGER},
        adID = #{record.adid,jdbcType=INTEGER}
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.WxActivity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        update wx_activity
        <set>
            <if test="code != null">
                code = #{code,jdbcType=VARCHAR},
            </if>
            <if test="imei != null">
                imei = #{imei,jdbcType=VARCHAR},
            </if>
            <if test="leid != null">
                leID = #{leid,jdbcType=INTEGER},
            </if>
            <if test="adid != null">
                adID = #{adid,jdbcType=INTEGER},
            </if>
        </set>
        where user_id = #{userId,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.WxActivity">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Aug 11 11:24:01 CST 2016.
        -->
        UPDATE wx_activity
        SET code = #{code,jdbcType=VARCHAR},
        imei = #{imei,jdbcType=VARCHAR},
        leID = #{leid,jdbcType=INTEGER},
        adID = #{adid,jdbcType=INTEGER}
        WHERE user_id = #{userId,jdbcType=INTEGER}
    </update>

    <select id="report" resultType="map">
        SELECT
        code,
        count(user_id) registCount,
        count(IF (investAmount > 0, TRUE, NULL)) investCount,
        count(IF (true_name IS NOT NULL,TRUE,NULL)) recCount,
        sum(investAmount) investAmount,
        sum(rechargeAmount) rechargeAmount,
        sum(withdrawAmount) withdrawAmount
        FROM
        (
        SELECT
        w.user_id,
        w.code,
        a.huo_investment_amount,
        u.true_name,
        sum(IF(tr.type = 1, tr.amount, 0)) rechargeAmount,
        sum(IF(tr.type = 2, tr.amount, 0)) withdrawAmount,
        sum(IF(tr.type = 0, tr.amount, 0)) investAmount
        FROM
        wx_activity w
        left join
        (
        select atm.code code,uinfo.uid from
        android_tunnel_management atm
        left join
        (
        select u.id as uid, u.username, u.true_name as trueName,r.role,r.description,r.id
        from
        user_admin u
        left join admin_role ar on ar.admin_id=u.id
        left join role r on r.id=ar.role_id
        ) as uinfo on atm.company=uinfo.id
        ) as info on info.code =w.code
        ,
        user u,
        assets a LEFT JOIN trade_record tr
        ON a.user_id = tr.user_id
        WHERE
        w.user_id = u.id
        AND w.user_id = a.user_id
        <if test="code !=null and code !=''">
            and w.code=#{code}
        </if>
        <if test="codes !=null and codes !=''">
            and w.code like '%${codes }%'
        </if>
        <if test="month !=null and month !=''">
            and u.register_time like '%${month }%'
        </if>
        GROUP BY
        w.user_id
        ) b
        GROUP BY code ORDER BY code+0 ASC
        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>
    </select>

    <select id="reportCount" resultType="int">
        select count(*) FROM
        (
        SELECT
        *
        FROM
        (
        SELECT
        w.user_id,
        w.code
        FROM
        wx_activity w
        left join
        (
        select atm.code code,uinfo.uid from
        android_tunnel_management atm
        left join
        (
        select u.id as uid, u.username, u.true_name as trueName,r.role,r.description,r.id
        from
        user_admin u
        left join admin_role ar on ar.admin_id=u.id
        left join role r on r.id=ar.role_id
        ) as uinfo on atm.company=uinfo.id
        ) as info on info.code =w.code
        ,
        user u,
        assets a LEFT JOIN trade_record tr
        ON a.user_id = tr.user_id
        WHERE
        w.user_id = u.id
        AND w.user_id = a.user_id
        <if test="code !=null and code !=''">
            and w.code=#{code}
        </if>
        <if test="codes !=null and codes !=''">
            and w.code like '%${codes }%'
        </if>
        <if test="month !=null and month !=''">
            and u.register_time like '%${month }%'
        </if>
        GROUP BY
        w.user_id
        ) b
        GROUP BY code ORDER BY code+0 ASC
        ) a

    </select>


    <select id="detail" parameterType="Map"
            resultType="com.goochou.p2b.model.ExportWxActivity">
        SELECT
        <if test="type == 0">
            CONCAT(
            SUBSTR(w.phone, 1, 4),
            '****',
            SUBSTR(w.phone, 8, 11)
            ) phone,
        </if>
        <if test="type == 1">
            w.phone phone,
        </if>
        sum(IF(w.type = 1, w.amount, 0)) rechargeAmount,
        sum(IF(w.type = 2, w.amount, 0)) withdrawAmount,
        w.available_balance balance,
        w.huo_investment_amount investAmount,
        w.register_time time,
        user_id userId,username,trueName
        from
        (
        SELECT
        a.*,tr.type,tr.amount
        FROM
        (
        SELECT
        w.user_id,u.phone,u.username,u.true_name trueName,a.huo_investment_amount,u.register_time,a.available_balance
        FROM
        wx_activity w,
        assets a,
        user u
        WHERE 1=1
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>

        AND w.user_id = a.user_id
        AND w.user_id = u.id
        ) a
        LEFT JOIN trade_record tr ON a.user_id = tr.user_id
        )w
        GROUP BY
        w.user_id
        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>
    </select>


    <select id="detail2" parameterType="Map" resultType="map">
        select * from(
        select u.id id1,
        sum(case when tr.type = 1 then tr.amount else 0 end ) chongzhi,
        sum(case when tr.type = 2 then tr.amount else 0 end ) tixian,
        sum(case when tr.type = 0 and tr.source =1 then tr.amount else 0 end ) huoqi,
        sum(case when tr.type = 6 then tr.amount else 0 end ) zhaiquan1
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        <if test="type == 0">
            and not EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="type == 3">
            and EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>
        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select u.params, u.id id2 ,u.phone,u.register_time,u.true_name,u.username,ass.available_balance,
        sum(ifnull(inv.amount,0)) amountTotal,
        sum(case when limit_days=7 and p.noob=1 then inv.amount else 0 end) amount_7,
        sum(case when limit_days=15 and p.noob=1 then inv.amount else 0 end) amount_15,
        sum(case when limit_days=28 and p.noob=1 then inv.amount else 0 end) amount_28,
        sum(case when limit_days=14 and p.noob=0 then inv.amount else 0 end) amount_14,
        sum(case when limit_days=30 then inv.amount else 0 end) amount_30,
        sum(case when limit_days=90 then inv.amount else 0 end) amount_90,
        sum(case when limit_days=180 then inv.amount else 0 end) amount_180,
        sum(case when inv.type=5 then inv.amount else 0 end) amount_huanle,
        sum(case when inv.type=6 then inv.amount else 0 end) amount_auto,
        sum(case when limit_days=365 then inv.amount else 0 end) amount_365
        from investment inv LEFT JOIN project p on p.id = inv.project_id right JOIN
        (select u.id,u.phone,u.register_time,u.true_name,u.username, wa.params from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        <if test="type == 0">
            and not EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="type == 3">
            and EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>
        ) u on inv.user_id = u.id LEFT JOIN assets ass on u.id =ass.user_id GROUP BY u.id
        )n on m.id1 = n.id2
        LEFT JOIN ( select sum(inv.amount) zhaiquan2,inv.user_id from 
       (select u.id,u.phone,u.register_time,u.true_name from wx_activity wa,user u where wa.user_id=u.id
       <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        <if test="type == 0">
            and not EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="type == 3">
            and EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>

        ) u

      LEFT JOIN trade_record tr  on  u.id = tr.user_id
      LEFT JOIN investment inv on tr.other_id = inv.id 
      LEFT JOIN project p on inv.project_id= p.id
        where tr.type = 10 and p.parent_id is not null GROUP BY inv.user_id ) s on n.id2= s.user_id
    </select>



    <select id="detailCount" parameterType="Map" resultType="int">
        select count(*) from (SELECT
        <if test="type == 0">
            CONCAT(
            SUBSTR(w.phone, 1, 4),
            '****',
            SUBSTR(w.phone, 8, 11)
            ) phone,
        </if>
        <if test="type == 1">
            w.phone phone,
        </if>
        sum(IF(w.type = 1, w.amount, 0)) rechargeAmount,
        sum(IF(w.type = 2,
        w.amount, 0)) withdrawAmount,
        w.available_balance balance,
        w.huo_investment_amount investAmount,
        w.register_time time,
        user_id
        userId,username,trueName
        from
        (
        SELECT
        a.*,tr.type,tr.amount
        FROM
        (
        SELECT
        w.user_id,u.phone,u.username,u.true_name
        trueName,a.huo_investment_amount,u.register_time,a.available_balance
        FROM
        wx_activity w,
        assets a,
        user u
        WHERE
        detailPage
        AND w.user_id =
        a.user_id
        AND w.user_id = u.id
        ) a
        LEFT JOIN trade_record tr ON a.user_id
        = tr.user_id
        )w
        GROUP BY
        w.user_id)cou
    </select>


    <select id="detailCount2" parameterType="Map" resultType="int">
		select count(u.id) from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        <if test="type == 0">
            and not EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>

        <if test="type == 3">
            and EXISTS(select 1 from investment i where wa.user_id=i.user_id)
        </if>
    </select>


    <select id="sumAmount" resultType="double" parameterType="map">
        select ROUND(sum(amount)/10000,2) from investment inv

        <if test="investType != null">
            right JOIN project p on inv.project_id = p.id where 1=1
            <if test="investType == 30 ">
                and inv.type=0
            </if>
            <if test="investType == 1 or investType == 2 ">
                and p.project_type=${investType}
            </if>
            <if test="investType ==3 ">
                and p.noob=1
            </if>
        </if>
        <if test="investType == null">
            where 1=1
        </if>
        and inv.user_id in (
        SELECT
        user_id
        from
        (
        SELECT
        a.*,tr.type,tr.amount
        FROM
        (
        SELECT
        w.user_id,u.phone,u.username,u.true_name
        trueName,a.huo_investment_amount,u.register_time,a.available_balance
        FROM
        wx_activity w,
        assets a,
        user u
        WHERE
        CODE = #{code}
        AND w.user_id =
        a.user_id
        AND w.user_id = u.id

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>


        <if test="types == 0">
            and u.true_name is NULL
        </if>
        <if test="types == 1">
            and u.true_name is not NULL
            and u.id not in (select DISTINCT (user_id) from bank_card )
        </if>
        <if test="types == 2">
            and u.id in (select DISTINCT (user_id) from bank_card )
            and u.id not in (select DISTINCT(user_id) from trade_record where type = 0)
        </if>


        <if test="type == 3">

            <if test="investType != null">
                and u.id in(
                select DISTINCT(inv.user_id) from investment inv right JOIN project p on inv.project_id = p.id where 1=1

                <if test="investType != null">
                    <if test="investType == 30 ">
                        and inv.type=0
                    </if>

                    <if test="investType == 1 or investType == 2 ">
                        and p.project_type=${investType}
                    </if>
                    <if test="investType ==3 ">
                        and p.noob=1

                    </if>
                </if>
                )
            </if>

            <if test="investType == null">
                and u.id in (select DISTINCT(user_id) from trade_record where type = 0)
            </if>
        </if>

        ) a
        LEFT JOIN trade_record tr ON a.user_id
        = tr.user_id
        )w
        GROUP BY
        w.user_id

        )

    </select>

    <select id="processZcAndSm" parameterType="map" resultType="map">
        SELECT
            wx.imei adID,
            u.true_name,
            u.identity_card
        FROM wx_activity wx, user u
        WHERE u.id = wx.user_id AND wx.`code` = '601' AND date_format(u.register_time, '%Y-%m-%d')
        BETWEEN date_format(#{startTime}, '%Y-%m-%d') AND date_format(#{endTime}, '%Y-%m-%d')
    </select>


    <select id="processBindCard" parameterType="map" resultType="map">
        SELECT
            wx.imei          adID,
            uor.bank_card_no cardNm
        FROM wx_activity wx, user_operation_record uor
        WHERE uor.user_id = wx.user_id AND wx.`code` = '601' AND uor.type = 0 AND uor.`status` = 1 AND
              date_format(uor.create_time, '%Y-%m-%d')
              BETWEEN date_format(#{startTime}, '%Y-%m-%d') AND date_format(#{endTime}, '%Y-%m-%d')
    </select>


    <select id="processInv" parameterType="map" resultType="map">
        SELECT
            wx.imei       adID,
            sum(i.amount) amount
        FROM wx_activity wx
            LEFT JOIN investment i ON wx.user_id = i.user_id
            LEFT JOIN project p ON p.id = i.project_id
        WHERE p.parent_id IS NULL AND p.noob = 0 AND p.project_type = 0 AND wx.code = '601'

              AND date_format(i.time, '%Y-%m-%d') BETWEEN date_format(#{startTime}, '%Y-%m-%d') AND date_format(#{endTime}, '%Y-%m-%d')
        GROUP BY i.user_id
    </select>


    <select id="processCommon" parameterType="map" resultType="map">
        SELECT
            u.phone,
            CASE WHEN u.true_name IS NOT NULL
                THEN 1
            ELSE 0 END    sm_status,
            CASE WHEN bc.card_number IS NOT NULL
                THEN 1
            ELSE 0 END    bk_status,
            inv.sumAmount tz_amount
        FROM wx_activity wx LEFT JOIN bank_card bc ON wx.user_id = bc.user_id
            LEFT JOIN user u ON u.id = wx.user_id
            LEFT JOIN
            (SELECT
                 user_id,
                 sum(amount) sumAmount
             FROM investment i
             WHERE DATE_FORMAT(i.time, '%y-%m-%d') BETWEEN DATE_FORMAT(#{startTime}, '%y-%m-%d') AND DATE_FORMAT(#{endTime}, '%y-%m-%d')
             GROUP BY user_id)
            inv ON u.id = inv.user_id
        WHERE bc.`status` = 0 AND wx.`code` = #{code};
    </select>


    <select id="dataAnalysis" parameterType="map" resultType="map">

        select n.code ,n.sumAll,n.sumFirst ,m.countOne countOne ,m.countMore countMore from (
        select wx.`code`,sum(fst.amount) sumFirst ,sum(fst.amountTotal) sumAll
        from wx_activity wx LEFT JOIN (
        select inv.user_id ,inv.amount ,sum(inv.amount) amountTotal from wx_activity wx LEFT JOIN investment inv on wx.user_id = inv.user_id
        where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>
        GROUP BY inv.user_id
        ) fst on wx.user_id =fst.user_id
        GROUP BY wx.`code`
        ) n LEFT JOIN (
        select m.code code ,m.countOne countOne,n.countMore countMore from (select wx.code,count(wx.user_id) countMore
        from wx_activity wx right JOIN (
        select user_id from investment inv where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>

        GROUP BY inv.user_id HAVING count(id)>1
        ) inv on wx.user_id = inv.user_id GROUP BY wx.`code`) n
        right JOIN (
        select wx.code ,count(*) countOne from wx_activity wx right JOIN (select DISTINCT(user_id) from investment inv where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>
        ) inv on wx.user_id = inv.user_id GROUP BY wx.`code`
        ) m on n.`code` = m.`code` or (n.code is null and m.code is null)
        ) m on n.`code` = m.`code` or (n.code is null and m.code is null)
        ORDER BY n.code+0
        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>

    </select>


    <select id="countDataAnalysis" parameterType="map" resultType="int">
        select count(*) from (
        select wx.`code`,sum(fst.amount) ,sum(fst.amountTotal) from wx_activity wx LEFT JOIN (
        select inv.user_id ,inv.amount ,sum(inv.amount) amountTotal from wx_activity wx LEFT JOIN investment inv on wx.user_id = inv.user_id
        where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>
        GROUP BY inv.user_id
        ) fst on wx.user_id =fst.user_id
        GROUP BY wx.`code`
        ) n LEFT JOIN (
        select m.code code ,m.countOne countOne,n.countMore countMore from (select wx.code,count(wx.user_id) countMore
        from wx_activity wx right JOIN (
        select user_id from investment inv where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>

        GROUP BY inv.user_id HAVING count(id)>1
        ) inv on wx.user_id = inv.user_id GROUP BY wx.`code`) n
        right JOIN (
        select wx.code ,count(*) countOne from wx_activity wx right JOIN (select DISTINCT(user_id) from investment inv where 1=1
        <if test="startTime != null and  endTime != null">
            and date_format(inv.time,'%Y-%m-%d') between date_format(#{startTime},'%Y-%m-%d') and date_format(#{endTime},'%Y-%m-%d')
        </if>
        ) inv on wx.user_id = inv.user_id GROUP BY wx.`code`
        ) m on n.`code` = m.`code`
        ) m on n.`code` = m.`code`
    </select>


    <select id="detail3" parameterType="Map" resultType="map">
        select * from(
        select u.id id2,
        sum(case when tr.type = 1 then tr.amount else 0 end ) chongzhi,
        sum(case when tr.type = 2 then tr.amount else 0 end ) tixian
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select inv.params, u.id,u.phone,u.register_time,u.true_name,u.username,ass.available_balance,inv.time,
        sum(amount) amountTotal,
        sum(case when project_type =0 and limit_days=7 and p.noob=1 then inv.amount else 0 end) amount_7,
        sum(case when project_type =0 and limit_days=15 and p.noob=1 then inv.amount else 0 end) amount_15,
        sum(case when project_type =0 and limit_days=28 and p.noob=1 then inv.amount else 0 end) amount_28,
        sum(case when project_type!=5 and limit_days=14 and p.noob=0 then inv.amount else 0 end) amount_14,
        sum(case when project_type!=5 and limit_days=30 then inv.amount else 0 end) amount_30,
        sum(case when project_type!=5 and limit_days=90 then inv.amount else 0 end) amount_90,
        sum(case when project_type!=5 and limit_days=180 then inv.amount else 0 end) amount_180,
        sum(case when project_type!=5 and limit_days=365 then inv.amount else 0 end) amount_365,
        sum(case when inv.type=5 then inv.amount else 0 end) amount_huanle,
        sum(case when project_type!=5 and p.parent_id is not null then inv.amount else 0 end) zhaiquan,
        sum(case when p.project_type=2 then inv.amount else 0 end) huoqi
        from (select u.params, inv.amount,inv.user_id,inv.project_id,inv.time,inv.type from investment inv ,(select u.id , wa.params from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u where inv.user_id=u.id GROUP BY u.id having(count(u.id)>=1) ORDER BY time) inv LEFT JOIN project p on p.id = inv.project_id left JOIN
        (select u.id,u.phone,u.register_time,u.true_name,u.username from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        ) u on inv.user_id = u.id LEFT JOIN assets ass on u.id =ass.user_id GROUP BY u.id
        )n on m.id2 = n.id


        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>

    </select>


    <select id="detailCount3" parameterType="Map" resultType="int">

        select count(*) from(
        select u.id id1
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select u.id id2,u.phone,u.register_time,u.true_name,ass.available_balance,inv.time
        from (select inv.amount,inv.user_id,inv.project_id,inv.time from investment inv ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u where inv.user_id=u.id GROUP BY u.id ORDER BY time) inv LEFT JOIN project p on p.id = inv.project_id left JOIN
        (select u.id,u.phone,u.register_time,u.true_name from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        ) u on inv.user_id = u.id LEFT JOIN assets ass on u.id =ass.user_id GROUP BY u.id
        )n on m.id1 = n.id2


    </select>


    <select id="detail4" parameterType="Map" resultType="map">
        select * from(
        select u.id id1,
        sum(case when tr.type = 1 then tr.amount else 0 end ) chongzhi,
        sum(case when tr.type = 2 then tr.amount else 0 end ) tixian
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>

        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select u.params, u.id id2 ,u.phone,u.register_time,u.true_name,u.username,ass.available_balance,ass.huo_investment_amount huoqi,
        sum(inv.amount) amountTotal,
        sum(case when project_type!=5 and limit_days=7 and p.noob=1 then inv.amount else 0 end) amount_7,
        sum(case when project_type=0 and limit_days=15 and p.noob=1 then inv.amount else 0 end) amount_15,
        sum(case when project_type!=5 and limit_days=28 and p.noob=1 then inv.amount else 0 end) amount_28,
        sum(case when project_type!=5 and limit_days=14 and p.noob=0 then inv.amount else 0 end) amount_14,
        sum(case when project_type!=5 and limit_days=30 then inv.amount else 0 end) amount_30,
        sum(case when project_type!=5 and limit_days=90 then inv.amount else 0 end) amount_90,
        sum(case when project_type!=5 and limit_days=180 then inv.amount else 0 end) amount_180,
        sum(case when project_type!=5 and limit_days=365 then inv.amount else 0 end) amount_365,
        sum(case when inv.type=5 then inv.interest_usable_amount else 0 end) amount_huanle,
        sum(case when inv.type=6 then inv.interest_usable_amount else 0 end) amount_auto,
        sum(case when project_type!=5 and p.parent_id is not null then inv.amount else 0 end) zhaiquan

        from (select * from investment inv where inv.id in(select investment_id from (select user_id,investment_id from interest where investment_id is not null and user_id is not null and has_dividended =0 ORDER BY id DESC ) s GROUP BY user_id) ) inv left JOIN project p on p.id = inv.project_id left JOIN
        (select u.id,u.phone,u.register_time,u.true_name,u.username ,code, wa.params from wx_activity wa,user u where wa.user_id=u.id

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u on inv.user_id = u.id LEFT JOIN assets ass on u.id =ass.user_id where (ass.huo_investment_amount>0 or ass.uncollect_capital> 0) and u.phone is not null
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        GROUP BY u.id
        )n on m.id1 = n.id2


        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>

    </select>


    <select id="detailCount4" parameterType="Map" resultType="int">
        select count(*) from(
        select u.id id2
        from (select * from investment inv where inv.id in(select investment_id from (select user_id,investment_id from interest where investment_id is not null and user_id is not null and has_dividended =0 ORDER BY id DESC ) s GROUP BY user_id) ) inv left JOIN project p on p.id = inv.project_id left JOIN
        (select u.id,u.phone,u.register_time,u.true_name,u.username ,code from wx_activity wa,user u where wa.user_id=u.id

        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u on inv.user_id = u.id LEFT JOIN assets ass on u.id =ass.user_id where (ass.huo_investment_amount>0 or ass.uncollect_capital> 0) and u.phone is not null
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        GROUP BY u.id
        ) m

    </select>


    <select id="detail5" parameterType="Map" resultType="map">
        select * from(
        select u.id,
        sum(case when tr.type = 1 then tr.amount else 0 end ) chongzhi,
        sum(case when tr.type = 2 then tr.amount else 0 end ) tixian
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>

        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select 
        sum(case when project_type!=5 and limit_days=14 and noob=0 then inv.amount else 0 end) amount_14,
        sum(case when project_type!=5 and limit_days=30 then inv.amount else 0 end) amount_30,
        sum(case when project_type!=5 and limit_days=90 then inv.amount else 0 end) amount_90,
        sum(case when project_type!=5 and limit_days=180 then inv.amount else 0 end) amount_180,
        sum(case when project_type!=5 and limit_days=365 then inv.amount else 0 end) amount_365,
        sum(case when project_type!=5 and inv.parent_id is not null then inv.amount else 0 end) zhaiquan,
        sum(case when project_type=2 then inv.amount else 0 end) huoqi,
        inv.user_id,inv.phone,inv.register_time,inv.true_name,inv.username,inv.available_balance, inv.params
        from
        (
        select m.*,ass.available_balance from
        (
        select u.params, inv.user_id user_id,inv.amount,inv.type,p.limit_days,p.noob,p.project_type,p.parent_id ,u.phone,u.register_time,u.true_name,u.username from investment inv , project p ,
        (select u.id,u.phone,u.register_time,u.true_name,u.username, wa.params
        from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u
        where
        inv.project_id = p.id and u.id = inv.user_id)
        m
        RIGHT JOIN
        (
        select inv.user_id id1 from investment inv ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u where inv.user_id=u.id GROUP BY u.id having(count(u.id)>1)
        ) n
        on m.user_id= n.id1 LEFT JOIN assets ass on m.user_id = ass.user_id
        ) inv GROUP BY inv.user_id


        )n on m.id = n.user_id


        <if test="start != null and limit !=null">
            limit #{start},#{limit}
        </if>

    </select>


    <select id="detailCount5" parameterType="Map" resultType="int">
        select count(*) from(
        select * from(
        select u.id,
        sum(case when tr.type = 1 then tr.amount else 0 end ) chongzhi,
        sum(case when tr.type = 2 then tr.amount else 0 end ) tixian
        from trade_record tr ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>

        ) u where tr.user_id = u.id GROUP BY u.id
        )m right JOIN (
        select
        inv.user_id,inv.phone,inv.register_time,inv.true_name,inv.available_balance
        from
        (
        select m.*,ass.available_balance from
        (
        select inv.user_id user_id,inv.amount,inv.type,p.limit_days,p.noob,p.project_type,p.parent_id ,u.phone,u.register_time,u.true_name from investment inv , project p ,
        (select u.id,u.phone,u.register_time,u.true_name from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u
        where
        inv.project_id = p.id and u.id = inv.user_id)
        m
        RIGHT JOIN
        (
        select inv.user_id id1 from investment inv ,(select u.id from wx_activity wa,user u where wa.user_id=u.id
        <if test="code == ''">
            and code is null
        </if>
        <if test="code != '' and code !=null">
            and CODE = #{code}
        </if>
        <if test="startTime != null and endTime == null">
            and u.register_time &gt; #{startTime}
        </if>
        <if test="startTime == null and  endTime != null">
            and u.register_time &lt; #{endTime}
        </if>
        <if test="startTime != null and  endTime != null">
            and u.register_time &gt; #{startTime} and u.register_time &lt; #{endTime}
        </if>
        ) u where inv.user_id=u.id GROUP BY u.id having(count(u.id)>1)
        ) n
        on m.user_id= n.id1 LEFT JOIN assets ass on m.user_id = ass.user_id
        ) inv GROUP BY inv.user_id
        )n on m.id = n.user_id
        ) m
    </select>


</mapper>