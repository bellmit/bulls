<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.goochou.p2b.dao.ProjectCreditorMapper">
    <resultMap id="BaseResultMap" type="com.goochou.p2b.model.ProjectCreditor">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="project_id" property="projectId" jdbcType="INTEGER"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="detail_id" property="detailId" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        <where>
            <foreach collection="oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" suffix=")" prefixOverrides="and">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach collection="criterion.value" item="listItem" open="(" close=")"
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" suffix=")" prefixOverrides="and">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach collection="criterion.value" item="listItem" open="(" close=")"
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        id, project_id, title, content, status, detail_id
    </sql>
    <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.goochou.p2b.model.ProjectCreditorExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="Base_Column_List"/>
        from project_creditor
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
        <if test="limitStart != null and limitStart>-1">
            limit ${limitStart} , ${limitEnd}
        </if>
    </select>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        select
        <include refid="Base_Column_List"/>
        from project_creditor
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        delete from project_creditor
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <delete id="deleteByExample" parameterType="com.goochou.p2b.model.ProjectCreditorExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        delete from project_creditor
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </delete>
    <insert id="insert" parameterType="com.goochou.p2b.model.ProjectCreditor" useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        insert into project_creditor (id, project_id, title,
        content, status, detail_id
        )
        values (#{id,jdbcType=INTEGER}, #{projectId,jdbcType=INTEGER}, #{title,jdbcType=VARCHAR},
        #{content,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, #{detailId,jdbcType=INTEGER}
        )
    </insert>
    <insert id="insertSelective" parameterType="com.goochou.p2b.model.ProjectCreditor" useGeneratedKeys="true"
            keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        insert into project_creditor
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="projectId != null">
                project_id,
            </if>
            <if test="title != null">
                title,
            </if>
            <if test="content != null">
                content,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="detailId != null">
                detail_id,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="projectId != null">
                #{projectId,jdbcType=INTEGER},
            </if>
            <if test="title != null">
                #{title,jdbcType=VARCHAR},
            </if>
            <if test="content != null">
                #{content,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="detailId != null">
                #{detailId,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <select id="countByExample" parameterType="com.goochou.p2b.model.ProjectCreditorExample"
            resultType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        select count(*) from project_creditor
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>
    <update id="updateByExampleSelective" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        update project_creditor
        <set>
            <if test="record.id != null">
                id = #{record.id,jdbcType=INTEGER},
            </if>
            <if test="record.projectId != null">
                project_id = #{record.projectId,jdbcType=INTEGER},
            </if>
            <if test="record.title != null">
                title = #{record.title,jdbcType=VARCHAR},
            </if>
            <if test="record.content != null">
                content = #{record.content,jdbcType=VARCHAR},
            </if>
            <if test="record.status != null">
                status = #{record.status,jdbcType=INTEGER},
            </if>
            <if test="record.detailId != null">
                detail_id = #{record.detailId,jdbcType=INTEGER},
            </if>
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        update project_creditor
        set id = #{record.id,jdbcType=INTEGER},
        project_id = #{record.projectId,jdbcType=INTEGER},
        title = #{record.title,jdbcType=VARCHAR},
        content = #{record.content,jdbcType=VARCHAR},
        status = #{record.status,jdbcType=INTEGER},
        detail_id = #{record.detailId,jdbcType=INTEGER}
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.ProjectCreditor">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        update project_creditor
        <set>
            <if test="projectId != null">
                project_id = #{projectId,jdbcType=INTEGER},
            </if>
            <if test="title != null">
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="content != null">
                content = #{content,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
            <if test="detailId != null">
                detail_id = #{detailId,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.ProjectCreditor">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 09 10:53:05 CST 2016.
        -->
        update project_creditor
        set project_id = #{projectId,jdbcType=INTEGER},
        title = #{title,jdbcType=VARCHAR},
        content = #{content,jdbcType=VARCHAR},
        status = #{status,jdbcType=INTEGER},
        detail_id = #{detailId,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="queryAllCreditorList" parameterType="map" resultType="map">
        SELECT r.*
        FROM(
        SELECT p1.*, pc.title titleCreditor,CASE WHEN p1.status= 0 THEN p1.dayDiff*(annualized) *(amount-invested_amount) /365 ELSE p1.dayDiff*(annualized) *amount/365 END income,
        CASE WHEN p1.status= 0 THEN p1.bond_management_rate*(amount-invested_amount) ELSE p1.bond_management_rate*amount END discountIncome
        FROM(
        SELECT b.id, b.invested_amount, b.invested_amount/b.total_amount percent, b.total_amount amount, b.status,b.bond_management_rate, p.id parentId, p.title, p.annualized, p.increase_annualized, b.deadline, p.create_time, p.limit_days,
        CASE WHEN b.status= 0 THEN DATEDIFF(ADDDATE(p.deadline, INTERVAL p.limit_days DAY),NOW()) ELSE DATEDIFF(ADDDATE(p.deadline, INTERVAL p.limit_days DAY), b.create_time) END dayDiff
        FROM project b, project p
        WHERE b.parent_id= p.id
        AND b.parent_id IS NOT NULL
        AND b.status!= 2
        AND p.id>= 506
        AND ((p.project_type= 0) or (b.project_type=7 and b.is_show_at_bond_invest=1))
        <if test="projectId != null">
            and b.id=#{projectId}
        </if>
        ) p1
        LEFT JOIN project_creditor pc ON p1.parentId= pc.project_id) r
        ORDER BY r.status,r.deadline DESC
        <if test="start != null and limit != null">
            limit #{start},#{limit}
        </if>
    </select>
    
    <sql id="NewAllCreditor_Column_List">
    	b.id, b.invested_amount, b.invested_amount/b.total_amount percent, b.total_amount amount, b.status,b.bond_management_rate,b.user_bond_management_rate, p.id parentId, p.title, p.annualized, p.increase_annualized, b.deadline, p.create_time, p.limit_days,
        CASE WHEN b.status= 0 THEN DATEDIFF(ADDDATE(p.deadline, INTERVAL p.limit_days DAY),NOW()) ELSE DATEDIFF(ADDDATE(p.deadline, INTERVAL p.limit_days DAY), b.create_time) END dayDiff,
        b.create_time as createTime
    </sql>
    
    <!-- 新的综合进行排序 -->
    <select id="queryNewAllCreditorList" parameterType="map" resultType="map">
      SELECT r.*
        FROM(
        SELECT p1.*, p1.title titleCreditor,CASE WHEN p1.status= 0 THEN p1.dayDiff*(annualized) *(amount-invested_amount) /365 ELSE p1.dayDiff*(annualized) *amount/365 END income,
        CASE WHEN p1.status= 0 THEN p1.bond_management_rate*(amount-invested_amount) ELSE p1.bond_management_rate*amount END discountIncome
        FROM(
	        SELECT 
	        	<include refid="NewAllCreditor_Column_List"/>
	         FROM project b left join project p 
        	 on b.parent_id= p.id
	        WHERE b.parent_id= p.id
	        AND b.parent_id IS NOT NULL
	        AND b.status!= 2
	        AND p.id>= 506
	        AND ((p.project_type= 0) or (b.project_type=7 and b.is_show_at_bond_invest=1))
	        <if test="projectId != null">
	            and b.id=#{projectId}
	        </if>
        ) p1) r
       	order by 
		r.status,
		r.user_bond_management_rate desc, r.createTime asc
        <if test="start != null and limit != null">
            limit #{start},#{limit}
        </if>
    </select>

    <select id="queryAllCreditorListCount" parameterType="map" resultType="int">
        select
        count(*)
        FROM
        project b, project p
        WHERE
        b.parent_id=p.id
        and b.parent_id IS NOT NULL
        AND b.STATUS != 2 and p.id>=506
        AND ((p.project_type= 0) or (b.project_type=7 and b.is_show_at_bond_invest=1))
        ORDER BY
        b.create_time DESC
    </select>
    
    <select id="queryNewAllCreditorListCount" parameterType="map" resultType="int">
    	select count(*) FROM(
	        SELECT 
		        	b.id
		        FROM project b left join project p
        	 	on b.parent_id= p.id
		        WHERE b.parent_id= p.id
		        AND b.parent_id IS NOT NULL
		        AND b.status!= 2
		        AND p.id>= 506
		        AND ((p.project_type= 0) or (b.project_type=7 and b.is_show_at_bond_invest=1))
		        <if test="projectId != null">
		            and b.id=#{projectId}
		        </if>
        ) t
    </select>

    <select id="queryCreditorDetail" parameterType="map" resultType="map">
		   SELECT
		   	pro.bond_management_rate bondManagementRate,
			pro.investmentId,
			pro.time,
			pro.totalAmount,
			pro.amount,
			pro.projectId,
			ppc.detail_id detailId,
			pp.title,
			pp.deadline,
			pp.annualized,pp.increase_annualized,
			e.name,
			pp.status,
			pp.limit_days,
			TIMESTAMPDIFF(HOUR,NOW(),pro.deadline) remainingHours,
			CASE WHEN pro.status= 0 THEN DATEDIFF(ADDDATE(pp.deadline, INTERVAL pp.limit_days DAY),CURDATE())
            ELSE DATEDIFF(ADDDATE(pp.deadline, INTERVAL pp.limit_days DAY), pro.create_time) END dayDiff,
            CASE WHEN pro.status= 0 THEN DATEDIFF(ADDDATE(pp.deadline, INTERVAL pp.limit_days DAY),CURDATE())*(pp.annualized) *(pro.totalAmount-pro.amount) /365
            ELSE DATEDIFF(ADDDATE(pp.deadline, INTERVAL pp.limit_days DAY), pro.create_time)*(pp.annualized) *pro.amount/365 END income,
            CASE WHEN pro.status= 0 THEN pro.bond_management_rate *(pro.totalAmount-pro.amount)
            ELSE pro.bond_management_rate *pro.amount END discountIncome
		FROM
			(
				SELECT
					i.id investmentId,
					p.create_time time,
					p.id projectId,
					p.title,
					p.total_amount totalAmount,
					p.invested_amount amount,
					p.deadline,
					p.annualized,
					p.parent_id,
					p.status,
					p.create_time,
					p.bond_management_rate
				FROM
					project p
				LEFT JOIN investment i ON i.id = p.investment_id
				WHERE
					p.id =#{projectId}
			) pro,
			project pp
		LEFT JOIN project_creditor ppc ON pp.id = ppc.project_id
		LEFT JOIN enterprise e ON e.id = pp.enterprise_id
		WHERE
			pro.parent_id = pp.id
  </select>

    <select id="queryProjectCreditorDetail" parameterType="map" resultType="map">
        select
        i.id,i.amount,i.time,
        p.id projectId, p.title, p.deadline, p.invested_amount invest, p.total_amount totalAmount, p.annualized,e.name,
        datediff(p.deadline,curdate()) dayDiff
        from
        project p left join investment i on p.investment_id=i.id
        left join enterprise e on e.id=p.enterprise_id
        where
        p.investment_id = #{investmentId}
    </select>

    <select id="checkProjectHasCreditor" parameterType="int" resultType="java.lang.Boolean">
        select exists (select * from project_creditor where project_id=#{projectId} )
    </select>

    <select id="queryProjectCreditorConfig" parameterType="int" resultType="map">
  	select 
		pc.id,pc.project_id projectId, pc.title, pc.content, pc.status, pc.detail_id detailId,
		p.title projectTitle,pt.title detailTitle 		
	from 
		project_creditor pc 
		left join project p on pc.project_id=p.id
		left join project_contract pt on pc.detail_id=pt.id
	where 
		pc.id=#{id} 
  </select>
    <select id="queryProjectConfig" parameterType="int" resultType="map">
        select
        pc.id,pc.project_id projectId, pc.title, pc.content, pc.status, pc.detail_id detailId,
        p.title projectTitle,pt.title detailTitle
        from
        project_creditor pc
        left join project p on pc.project_id=p.id
        left join project_contract pt on pc.detail_id=pt.id
        where
        p.id=#{id}
    </select>

    <select id="checkContractDelete" parameterType="int" resultType="java.lang.Boolean">
  	select exists (select * from project_creditor where detail_id=#{detailId})
  </select>

    <select id="queryCreditorDeailByProjectId" parameterType="map" resultType="com.goochou.p2b.model.ProjectCreditor">
  	select * from project_creditor where project_id=#{projectId} 
  </select>
</mapper>
