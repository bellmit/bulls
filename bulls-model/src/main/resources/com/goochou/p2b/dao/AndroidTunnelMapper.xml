<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goochou.p2b.dao.AndroidTunnelMapper">
    <resultMap id="BaseResultMap" type="com.goochou.p2b.model.AndroidTunnel">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="code" jdbcType="VARCHAR" property="code"/>
        <result column="imei" jdbcType="VARCHAR" property="imei"/>
        <result column="active_time" jdbcType="TIMESTAMP" property="activeTime"/>
        <result column="callback" jdbcType="VARCHAR" property="callback"/>
        <result column="muid" jdbcType="VARCHAR" property="muid"/>
        <result column="os" jdbcType="VARCHAR" property="os"/>
        <result column="source" jdbcType="VARCHAR" property="source"/>
        <result column="conv_time" jdbcType="TIMESTAMP" property="convTime"/>
        <result column="signature" jdbcType="VARCHAR" property="signature"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
    </resultMap>
    <sql id="Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        <where>
            <foreach collection="oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="("
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Update_By_Example_Where_Clause">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        <where>
            <foreach collection="example.oredCriteria" item="criteria" separator="or">
                <if test="criteria.valid">
                    <trim prefix="(" prefixOverrides="and" suffix=")">
                        <foreach collection="criteria.criteria" item="criterion">
                            <choose>
                                <when test="criterion.noValue">
                                    and ${criterion.condition}
                                </when>
                                <when test="criterion.singleValue">
                                    and ${criterion.condition} #{criterion.value}
                                </when>
                                <when test="criterion.betweenValue">
                                    and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                                </when>
                                <when test="criterion.listValue">
                                    and ${criterion.condition}
                                    <foreach close=")" collection="criterion.value" item="listItem" open="("
                                             separator=",">
                                        #{listItem}
                                    </foreach>
                                </when>
                            </choose>
                        </foreach>
                    </trim>
                </if>
            </foreach>
        </where>
    </sql>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        id, code, imei, active_time, callback, muid, os, source, conv_time, signature, status
    </sql>
    <select id="selectByExample" parameterType="com.goochou.p2b.model.AndroidTunnelExample" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        select
        <if test="distinct">
            distinct
        </if>
        <include refid="Base_Column_List"/>
        from android_tunnel
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
        <if test="limitStart != null and limitStart&gt;-1">
            limit ${limitStart} , ${limitEnd}
        </if>
    </select>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        select
        <include refid="Base_Column_List"/>
        from android_tunnel
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        DELETE FROM android_tunnel
        WHERE id = #{id,jdbcType=INTEGER}
    </delete>
    <delete id="deleteByExample" parameterType="com.goochou.p2b.model.AndroidTunnelExample">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        delete from android_tunnel
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </delete>
    <insert id="insert" keyProperty="id" parameterType="com.goochou.p2b.model.AndroidTunnel" useGeneratedKeys="true">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        INSERT INTO android_tunnel (id, code, imei,
        active_time, callback, muid,
        os, source, conv_time,
        signature, status)
        VALUES (#{id,jdbcType=INTEGER}, #{code,jdbcType=VARCHAR}, #{imei,jdbcType=VARCHAR},
        #{activeTime,jdbcType=TIMESTAMP}, #{callback,jdbcType=VARCHAR}, #{muid,jdbcType=VARCHAR},
        #{os,jdbcType=VARCHAR}, #{source,jdbcType=VARCHAR}, #{convTime,jdbcType=TIMESTAMP},
        #{signature,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER})
    </insert>
    <insert id="insertSelective" parameterType="com.goochou.p2b.model.AndroidTunnel">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        insert into android_tunnel
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="code != null">
                code,
            </if>
            <if test="imei != null">
                imei,
            </if>
            <if test="activeTime != null">
                active_time,
            </if>
            <if test="callback != null">
                callback,
            </if>
            <if test="muid != null">
                muid,
            </if>
            <if test="os != null">
                os,
            </if>
            <if test="source != null">
                source,
            </if>
            <if test="convTime != null">
                conv_time,
            </if>
            <if test="signature != null">
                signature,
            </if>
            <if test="status != null">
                status,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="code != null">
                #{code,jdbcType=VARCHAR},
            </if>
            <if test="imei != null">
                #{imei,jdbcType=VARCHAR},
            </if>
            <if test="activeTime != null">
                #{activeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="callback != null">
                #{callback,jdbcType=VARCHAR},
            </if>
            <if test="muid != null">
                #{muid,jdbcType=VARCHAR},
            </if>
            <if test="os != null">
                #{os,jdbcType=VARCHAR},
            </if>
            <if test="source != null">
                #{source,jdbcType=VARCHAR},
            </if>
            <if test="convTime != null">
                #{convTime,jdbcType=TIMESTAMP},
            </if>
            <if test="signature != null">
                #{signature,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>
    <select id="countByExample" parameterType="com.goochou.p2b.model.AndroidTunnelExample"
            resultType="java.lang.Integer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        select count(*) from android_tunnel
        <if test="_parameter != null">
            <include refid="Example_Where_Clause"/>
        </if>
    </select>
    <update id="updateByExampleSelective" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        update android_tunnel
        <set>
            <if test="record.id != null">
                id = #{record.id,jdbcType=INTEGER},
            </if>
            <if test="record.code != null">
                code = #{record.code,jdbcType=VARCHAR},
            </if>
            <if test="record.imei != null">
                imei = #{record.imei,jdbcType=VARCHAR},
            </if>
            <if test="record.activeTime != null">
                active_time = #{record.activeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.callback != null">
                callback = #{record.callback,jdbcType=VARCHAR},
            </if>
            <if test="record.muid != null">
                muid = #{record.muid,jdbcType=VARCHAR},
            </if>
            <if test="record.os != null">
                os = #{record.os,jdbcType=VARCHAR},
            </if>
            <if test="record.source != null">
                source = #{record.source,jdbcType=VARCHAR},
            </if>
            <if test="record.convTime != null">
                conv_time = #{record.convTime,jdbcType=TIMESTAMP},
            </if>
            <if test="record.signature != null">
                signature = #{record.signature,jdbcType=VARCHAR},
            </if>
            <if test="record.status != null">
                status = #{record.status,jdbcType=INTEGER},
            </if>
        </set>
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByExample" parameterType="map">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        update android_tunnel
        set id = #{record.id,jdbcType=INTEGER},
        code = #{record.code,jdbcType=VARCHAR},
        imei = #{record.imei,jdbcType=VARCHAR},
        active_time = #{record.activeTime,jdbcType=TIMESTAMP},
        callback = #{record.callback,jdbcType=VARCHAR},
        muid = #{record.muid,jdbcType=VARCHAR},
        os = #{record.os,jdbcType=VARCHAR},
        source = #{record.source,jdbcType=VARCHAR},
        conv_time = #{record.convTime,jdbcType=TIMESTAMP},
        signature = #{record.signature,jdbcType=VARCHAR},
        status = #{record.status,jdbcType=INTEGER}
        <if test="_parameter != null">
            <include refid="Update_By_Example_Where_Clause"/>
        </if>
    </update>
    <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.AndroidTunnel">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        update android_tunnel
        <set>
            <if test="code != null">
                code = #{code,jdbcType=VARCHAR},
            </if>
            <if test="imei != null">
                imei = #{imei,jdbcType=VARCHAR},
            </if>
            <if test="activeTime != null">
                active_time = #{activeTime,jdbcType=TIMESTAMP},
            </if>
            <if test="callback != null">
                callback = #{callback,jdbcType=VARCHAR},
            </if>
            <if test="muid != null">
                muid = #{muid,jdbcType=VARCHAR},
            </if>
            <if test="os != null">
                os = #{os,jdbcType=VARCHAR},
            </if>
            <if test="source != null">
                source = #{source,jdbcType=VARCHAR},
            </if>
            <if test="convTime != null">
                conv_time = #{convTime,jdbcType=TIMESTAMP},
            </if>
            <if test="signature != null">
                signature = #{signature,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.AndroidTunnel">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu May 18 18:38:06 CST 2017.
        -->
        UPDATE android_tunnel
        SET code = #{code,jdbcType=VARCHAR},
        imei = #{imei,jdbcType=VARCHAR},
        active_time = #{activeTime,jdbcType=TIMESTAMP},
        callback = #{callback,jdbcType=VARCHAR},
        muid = #{muid,jdbcType=VARCHAR},
        os = #{os,jdbcType=VARCHAR},
        source = #{source,jdbcType=VARCHAR},
        conv_time = #{convTime,jdbcType=TIMESTAMP},
        signature = #{signature,jdbcType=VARCHAR},
        status = #{status,jdbcType=INTEGER}
        WHERE id = #{id,jdbcType=INTEGER}
    </update>

    <select id="selectAll" resultType="map">
        SELECT *
        FROM android_tunnel
        ORDER BY code
    </select>

    <select id="selectCountByChannelCode" parameterType="java.lang.String" resultType="map">
        select count(*) as count, code, current_timestamp() as date from android_tunnel
        <if test="code != null">
            where code=#{code,jdbcType=VARCHAR}
        </if>
        group by code
    </select>

    <select id="selectByChannelCode" parameterType="java.lang.String" resultType="map">
        select * from android_tunnel
        <if test="code != null">
            where code=#{code,jdbcType=VARCHAR}
        </if>
        order by code
    </select>

    <select id="queryAllPage" parameterType="map" resultType="map">
        select * from
        (
        select
        atm.jigou,
        atm.company,
        ant.code,
        count(distinct ant.imei) as linkcnt,
        count(distinct case when wxa.user_id is not null then wxa.user_id end) as regcount,
        count(distinct case when bc.card_number is not null then bc.user_id end ) as bindcount,
        count(distinct case when tr.touzi > 0 then bc.user_id end ) as tzshu,
        sum(ifnull(tr.touzi,0)) touzi,
		sum(ifnull(tr.chongzhi,0)) chongzhi,
		sum(ifnull(tr.tixian,0)) tixian
        from
        android_tunnel as ant
        left join wx_activity wxa on ant.imei=wxa.imei
        left join
        (
        select
        trr.type,
        trr.user_id,
        sum(if(trr.type=0,trr.amount,0)) touzi,
        sum(if(trr.type=1,trr.amount,0)) chongzhi,
        sum(if(trr.type=2,trr.amount,0)) tixian,
        sum(trr.balance) balance
        from trade_record trr 
        <![CDATA[
        where trr.time>=CONCAT(DATE_FORMAT(#{date},'%Y-%m-%d'),' 00:00:00') and trr.time<=CONCAT(DATE_FORMAT(#{endTime},'%Y-%m-%d'),' 23:59:59')
        ]]>
        group by trr.user_id
        ) as tr on tr.user_id=wxa.user_id
        left join bank_card bc on bc.user_id=wxa.user_id
        left join (select a.code, a.company, role.role, role.description as jigou from android_tunnel_management a
        left join role on role.id=a.company) atm on atm.code=ant.code where
        CASE WHEN ant.source= 'TD' THEN ant.status=1 ELSE ant.source is null END
        <![CDATA[
        and ant.active_time>=CONCAT(DATE_FORMAT(#{date},'%Y-%m-%d'),' 00:00:00') and ant.active_time<=CONCAT(DATE_FORMAT(#{endTime},'%Y-%m-%d'),' 23:59:59')
        ]]>
        group by ant.code order by atm.company desc
        )as tt left join (
        select code,count(*) clickcnt from android_tunnel_click group by code
        )as atc on tt.code=atc.code
    </select>

    <select id="queryCount" resultType="java.lang.Integer">
        SELECT count(*)
        FROM
            wx_activity wxa
            LEFT JOIN trade_record tr ON tr.user_id = wxa.user_id
            LEFT JOIN bank_card bc ON bc.user_id = wxa.user_id
            LEFT JOIN android_tunnel ant ON ant.imei = wxa.imei
    </select>

    <select id="queryTotal" parameterType="map" resultType="map">
        select
        count(distinct ant.imei) as linkcnt,
        count(distinct case when wxa.imei is not null then wxa.user_id end) as regcount,
        count(distinct case when bc.card_number is not null then bc.user_id end ) as bindcount,
        count(distinct case when tr.type=0 then bc.user_id end ) as tzshu,
        sum(ifnull(tr.touzi,0)) touzi,
		sum(ifnull(tr.chongzhi,0)) chongzhi,
		sum(ifnull(tr.tixian,0)) tixian
        from
        android_tunnel as ant
        left join wx_activity wxa on ant.imei=wxa.imei
        left join
        (
        select
        trr.type,
        trr.user_id,
        sum(if(trr.type=0,trr.amount,0)) touzi,
        sum(if(trr.type=1,trr.amount,0)) chongzhi,
        sum(if(trr.type=2,trr.amount,0)) tixian,
        sum(trr.balance) balance
        from trade_record trr 
        <![CDATA[
        where trr.time>=CONCAT(DATE_FORMAT(#{date},'%Y-%m-%d'),' 00:00:00') and trr.time<=CONCAT(DATE_FORMAT(#{endTime},'%Y-%m-%d'),' 23:59:59')
        ]]>
        group by trr.user_id
        ) as tr on tr.user_id=wxa.user_id
        left join bank_card bc on bc.user_id=wxa.user_id
        left join (select a.code, a.company, role.role, role.description as jigou from android_tunnel_management a
        left join role on role.id=a.company) atm on atm.code=ant.code where
        CASE WHEN ant.source= 'TD' THEN ant.status=1 ELSE ant.source is null END
        <![CDATA[
        and ant.active_time>=CONCAT(DATE_FORMAT(#{date},'%Y-%m-%d'),' 00:00:00') and ant.active_time<=CONCAT(DATE_FORMAT(#{endTime},'%Y-%m-%d'),' 23:59:59')
        ]]>
    </select>

    <select id="queryAllAndroidDetailListByCodePage" parameterType="map" resultType="map">
        select ant.id,ant.code as inCode,ant.imei, wxa.code as rgCode, u.register_time as time,
        s.huo_investment_amount+s.uncollect_capital as investAmount, s.available_balance as balance, tr.rechargeAmount,
        tr.withdrawAmount, u.id as uid, u.username, u.true_name as trueName, u.phone
        from
        android_tunnel as ant
        left join wx_activity wxa on ant.imei=wxa.imei or ant.imei = MD5(wxa.imei)
        left join
        (
        select
        trr.user_id,
        sum(if(trr.type=0,trr.amount,0)) investAmount,
        sum(if(trr.type=1,trr.amount,0)) rechargeAmount,
        sum(if(trr.type=2,trr.amount,0)) withdrawAmount,
        sum(trr.balance) balance
        from trade_record trr 
        <![CDATA[
        where trr.time>=CONCAT(DATE_FORMAT(#{startDate},'%Y-%m-%d'),' 00:00:00') and trr.time<=CONCAT(DATE_FORMAT(#{endDate},'%Y-%m-%d'),' 23:59:59')
        ]]>
        group by trr.user_id
        ) as tr on tr.user_id=wxa.user_id
        left join assets s on s.user_id=tr.user_id
        left join `user` u on u.id=wxa.user_id
        where wxa.user_id is not null and ant.code=#{code}
        <![CDATA[
        and ant.active_time>=CONCAT(DATE_FORMAT(#{startDate},'%Y-%m-%d'),' 00:00:00') and ant.active_time<=CONCAT(DATE_FORMAT(#{endDate},'%Y-%m-%d'),' 23:59:59')
        ]]>
        ORDER BY `time` DESC
        <if test="start != null and limit != null">
            limit #{start} , #{limit}
        </if>
    </select>
    <select id="queryAllAndroidDetailListByCode" parameterType="map" resultType="map">
        SELECT
            ant.id,
            ant.code                                      AS inCode,
            ant.imei,
            wxa.code                                      AS rgCode,
            u.register_time                               AS time,
            s.huo_investment_amount + s.uncollect_capital AS investAmount,
            s.available_balance                           AS balance,
            tr.rechargeAmount,
            tr.withdrawAmount,
            u.id                                          AS uid,
            u.username,
            u.true_name                                   AS trueName,
            u.phone
        FROM
            android_tunnel AS ant
            LEFT JOIN wx_activity wxa ON ant.imei = wxa.imei OR ant.imei = MD5(wxa.imei)
            LEFT JOIN
            (
                SELECT
                    trr.user_id,
                    sum(if(trr.type = 0, trr.amount, 0)) investAmount,
                    sum(if(trr.type = 1, trr.amount, 0)) rechargeAmount,
                    sum(if(trr.type = 2, trr.amount, 0)) withdrawAmount,
                    sum(trr.balance)                     balance
                FROM trade_record trr
                <![CDATA[
		        where trr.time>=CONCAT(#{startDate},' 00:00:00') and trr.time<=CONCAT(#{endDate},' 23:59:59')
		        ]]>
                GROUP BY trr.user_id
            ) AS tr ON tr.user_id = wxa.user_id
            LEFT JOIN assets s ON s.user_id = tr.user_id
            LEFT JOIN user u ON u.id = wxa.user_id
        WHERE wxa.user_id IS NOT NULL AND ant.code = #{code}
         <![CDATA[
        and u.register_time>=CONCAT(#{startDate},' 00:00:00') and u.register_time<=CONCAT(#{endDate},' 23:59:59')
        ]]>
        ORDER BY `time` DESC
    </select>

    <select id="queryCountAllAndroidDetailListByCode" parameterType="map" resultType="java.lang.Integer">
        SELECT COUNT(ant.id)
        FROM
            android_tunnel AS ant
            LEFT JOIN wx_activity wxa
                ON ant.imei = wxa.imei OR ant.imei = MD5(wxa.imei)
            LEFT JOIN
            (SELECT
                 trr.user_id,
                 SUM(IF(trr.type = 0, trr.amount, 0)) investAmount,
                 SUM(IF(trr.type = 1, trr.amount, 0)) rechargeAmount,
                 SUM(IF(trr.type = 2, trr.amount, 0)) withdrawAmount,
                 SUM(trr.balance)                     balance
             FROM
                 trade_record trr
             <![CDATA[
		        where trr.time>=CONCAT(#{startDate},' 00:00:00') and trr.time<=CONCAT(#{endDate},' 23:59:59')
		       ]]>
             GROUP BY trr.user_id) AS tr
                ON tr.user_id = wxa.user_id
            LEFT JOIN assets s
                ON s.user_id = tr.user_id
            LEFT JOIN `user` u
                ON u.id = wxa.user_id
        WHERE wxa.user_id IS NOT NULL
        <![CDATA[
        and u.register_time>=CONCAT(#{startDate},' 00:00:00') and u.register_time<=CONCAT(#{endDate},' 23:59:59')
        ]]>
              AND ant.code = #{code}
    </select>
    <select id="queryIsInAndroidTrunnelManagement" parameterType="int" resultType="java.lang.Integer">
        SELECT count(*)
        FROM
            android_tunnel_management atm
        WHERE atm.company IN (
            SELECT r.id
            FROM user_admin u LEFT JOIN admin_role ar ON ar.admin_id = u.id
                LEFT JOIN role r ON r.id = ar.role_id
            WHERE u.id = #{id}
        )
    </select>

    <select id="queryCountByUserRole" parameterType="map" resultType="map">
        select ant.code,count(*) as count,info.username, info.trueName, info.role, info.uid
        from android_tunnel ant
        left join
        (
        select atm.code,atm.company,uinfo.username,uinfo.trueName,uinfo.role,uinfo.uid from
        android_tunnel_management atm
        left join
        (
        select u.id as uid, u.username, u.true_name as trueName,r.role,r.description,r.id
        from
        user_admin u
        left join admin_role ar on ar.admin_id=u.id
        left join role r on r.id=ar.role_id
        ) as uinfo on atm.company=uinfo.id
        ) as info on ant.code=info.code where
        CASE WHEN ant.source= 'TD' THEN ant.status=1 ELSE ant.source is null END
        <if test="cnt &gt; 0">
            and info.uid=#{id}
        </if>
        group by ant.code;
    </select>


    <select id="queryDailyCountByUserRole" parameterType="map" resultType="map">
        select ant.code,date_format(ant.active_time,'%Y-%m-%d') as time,count(*) as count,info.username, info.trueName,
        info.role, info.uid
        from android_tunnel ant
        left join
        (
        select atm.code,atm.company,uinfo.username,uinfo.trueName,uinfo.role,uinfo.uid from
        android_tunnel_management atm
        left join
        (
        select u.id as uid, u.username, u.true_name as trueName,r.role,r.description,r.id
        from
        user_admin u
        left join admin_role ar on ar.admin_id=u.id
        left join role r on r.id=ar.role_id
        ) as uinfo on atm.company=uinfo.id
        ) as info on ant.code=info.code where
        CASE WHEN ant.source= 'TD' THEN ant.status=1 ELSE ant.source is null END
        <if test="code != null">
            and ant.code=#{code}
        </if>
        <if test="code == 7">
            and ant.status=1
        </if>
        <if test="cnt &gt; 0">
            and info.uid=#{id}
        </if>
        group by ant.code, date_format(ant.active_time,'%Y-%m-%d')
        <if test="start != null and limit != null">
            limit #{start} , #{limit}
        </if>
    </select>


    <select id="queryAllDailyCountByUserRole" parameterType="map" resultType="int">
        select count(t.cnt) from (
        select count(date_format(ant.active_time,'%Y-%m-%d')) cnt
        from android_tunnel ant
        left join
        (
        select atm.code,atm.company,uinfo.username,uinfo.trueName,uinfo.role,uinfo.uid from
        android_tunnel_management atm
        left join
        (
        select u.id as uid, u.username, u.true_name as trueName,r.role,r.description,r.id
        from
        user_admin u
        left join admin_role ar on ar.admin_id=u.id
        left join role r on r.id=ar.role_id
        ) as uinfo on atm.company=uinfo.id
        ) as info on ant.code=info.code where
        CASE WHEN ant.source= 'TD' THEN ant.status=1 ELSE ant.source is null END
        <if test="code != null">
            and ant.code=#{code}
        </if>
        <if test="code == 7">
            and ant.status=1
        </if>
        <if test="cnt &gt; 0">
            and info.uid=#{id}
        </if>
        group by ant.code, date_format(ant.active_time,'%Y-%m-%d')
        ) as t
    </select>

    <select id="queryAndroidTrunnelManagement" parameterType="map" resultType="map">
        SELECT *
        FROM
            android_tunnel_management atm
        WHERE atm.company IN (
            SELECT r.id
            FROM user_admin u LEFT JOIN admin_role ar ON ar.admin_id = u.id
                LEFT JOIN role r ON r.id = ar.role_id
            WHERE u.id = #{id}
                  AND atm.source = #{source}
        )
    </select>

    <select id="queryByImei" parameterType="map" resultMap="BaseResultMap">
        SELECT *
        FROM android_tunnel
        WHERE imei = #{imei} OR imei = #{imeiMd5} OR md5(imei) = #{imei}
        <if test="status != null">
            and status=#{status}
        </if>
        LIMIT 1
    </select>

    <select id="queryImeiByUserId" parameterType="int" resultType="String">
        SELECT a.imei  FROM android_tunnel a LEFT JOIN wx_activity wx ON a.imei=wx.imei OR a.imei = MD5(wx.imei)
        WHERE wx.user_id = #{userId} LIMIT 1
    </select>

</mapper>