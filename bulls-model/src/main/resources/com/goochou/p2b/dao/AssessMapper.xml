<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goochou.p2b.dao.AssessMapper">
  <resultMap id="BaseResultMap" type="com.goochou.p2b.model.Assess">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="order_id" jdbcType="INTEGER" property="orderId" />
    <result column="goods_id" jdbcType="INTEGER" property="goodsId" />
    <result column="parent_id" jdbcType="INTEGER" property="parentId" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="state" jdbcType="INTEGER" property="state" />
    <result column="is_anonymous" jdbcType="INTEGER" property="isAnonymous" />
    <result column="is_top" jdbcType="INTEGER" property="isTop" />
    <result column="top_date" jdbcType="TIMESTAMP" property="topDate" />
    <result column="create_date" jdbcType="TIMESTAMP" property="createDate" />
    <result column="update_date" jdbcType="TIMESTAMP" property="updateDate" />
    <collection property="childen"  ofType="com.goochou.p2b.model.Assess" select="selectById" column="id"/>
    <collection property="assessImgs" column="id"  ofType="com.goochou.p2b.model.AssessImgs"
		select="com.goochou.p2b.dao.AssessImgsMapper.listAssessImgPath"/>
  </resultMap>
   
	<select id="selectById" resultMap="BaseResultMap">
		select  <include refid="Base_Column_List" /> from t_assess where parent_id = #{id}
	</select>
	
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    id, order_id, goods_id, parent_id, type, user_id, content, state, is_anonymous, is_top, 
    top_date, create_date, update_date
  </sql>
  <select id="selectByExample" parameterType="com.goochou.p2b.model.AssessExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from t_assess
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
    <if test="limitStart != null and limitStart&gt;-1">
      limit ${limitStart} , ${limitEnd}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    select 
    <include refid="Base_Column_List" />
    from t_assess
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    delete from t_assess
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.goochou.p2b.model.AssessExample">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    delete from t_assess
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" keyProperty="id" parameterType="com.goochou.p2b.model.Assess" useGeneratedKeys="true">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into t_assess (order_id, goods_id, parent_id, 
      type, user_id, content, 
      state, is_anonymous, is_top, 
      top_date, create_date, update_date
      )
    values (#{orderId,jdbcType=INTEGER}, #{goodsId,jdbcType=INTEGER}, #{parentId,jdbcType=INTEGER}, 
      #{type,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{content,jdbcType=VARCHAR}, 
      #{state,jdbcType=INTEGER}, #{isAnonymous,jdbcType=INTEGER}, #{isTop,jdbcType=INTEGER}, 
      #{topDate,jdbcType=TIMESTAMP}, #{createDate,jdbcType=TIMESTAMP}, #{updateDate,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.goochou.p2b.model.Assess">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into t_assess
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="orderId != null">
        order_id,
      </if>
      <if test="goodsId != null">
        goods_id,
      </if>
      <if test="parentId != null">
        parent_id,
      </if>
      <if test="type != null">
        type,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="content != null">
        content,
      </if>
      <if test="state != null">
        state,
      </if>
      <if test="isAnonymous != null">
        is_anonymous,
      </if>
      <if test="isTop != null">
        is_top,
      </if>
      <if test="topDate != null">
        top_date,
      </if>
      <if test="createDate != null">
        create_date,
      </if>
      <if test="updateDate != null">
        update_date,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="orderId != null">
        #{orderId,jdbcType=INTEGER},
      </if>
      <if test="goodsId != null">
        #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="parentId != null">
        #{parentId,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        #{type,jdbcType=INTEGER},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="content != null">
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="state != null">
        #{state,jdbcType=INTEGER},
      </if>
      <if test="isAnonymous != null">
        #{isAnonymous,jdbcType=INTEGER},
      </if>
      <if test="isTop != null">
        #{isTop,jdbcType=INTEGER},
      </if>
      <if test="topDate != null">
        #{topDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createDate != null">
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateDate != null">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.goochou.p2b.model.AssessExample" resultType="java.lang.Long">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    select count(*) from t_assess
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    update t_assess
    <set>
      <if test="record.id != null">
        id = #{record.id,jdbcType=INTEGER},
      </if>
      <if test="record.orderId != null">
        order_id = #{record.orderId,jdbcType=INTEGER},
      </if>
      <if test="record.goodsId != null">
        goods_id = #{record.goodsId,jdbcType=INTEGER},
      </if>
      <if test="record.parentId != null">
        parent_id = #{record.parentId,jdbcType=INTEGER},
      </if>
      <if test="record.type != null">
        type = #{record.type,jdbcType=INTEGER},
      </if>
      <if test="record.userId != null">
        user_id = #{record.userId,jdbcType=INTEGER},
      </if>
      <if test="record.content != null">
        content = #{record.content,jdbcType=VARCHAR},
      </if>
      <if test="record.state != null">
        state = #{record.state,jdbcType=INTEGER},
      </if>
      <if test="record.isAnonymous != null">
        is_anonymous = #{record.isAnonymous,jdbcType=INTEGER},
      </if>
      <if test="record.isTop != null">
        is_top = #{record.isTop,jdbcType=INTEGER},
      </if>
      <if test="record.topDate != null">
        top_date = #{record.topDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.createDate != null">
        create_date = #{record.createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="record.updateDate != null">
        update_date = #{record.updateDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    update t_assess
    set id = #{record.id,jdbcType=INTEGER},
      order_id = #{record.orderId,jdbcType=INTEGER},
      goods_id = #{record.goodsId,jdbcType=INTEGER},
      parent_id = #{record.parentId,jdbcType=INTEGER},
      type = #{record.type,jdbcType=INTEGER},
      user_id = #{record.userId,jdbcType=INTEGER},
      content = #{record.content,jdbcType=VARCHAR},
      state = #{record.state,jdbcType=INTEGER},
      is_anonymous = #{record.isAnonymous,jdbcType=INTEGER},
      is_top = #{record.isTop,jdbcType=INTEGER},
      top_date = #{record.topDate,jdbcType=TIMESTAMP},
      create_date = #{record.createDate,jdbcType=TIMESTAMP},
      update_date = #{record.updateDate,jdbcType=TIMESTAMP}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.Assess">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    update t_assess
    <set>
      <if test="orderId != null">
        order_id = #{orderId,jdbcType=INTEGER},
      </if>
      <if test="goodsId != null">
        goods_id = #{goodsId,jdbcType=INTEGER},
      </if>
      <if test="parentId != null">
        parent_id = #{parentId,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="content != null">
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="state != null">
        state = #{state,jdbcType=INTEGER},
      </if>
      <if test="isAnonymous != null">
        is_anonymous = #{isAnonymous,jdbcType=INTEGER},
      </if>
      <if test="isTop != null">
        is_top = #{isTop,jdbcType=INTEGER},
      </if>
      <if test="topDate != null">
        top_date = #{topDate,jdbcType=TIMESTAMP},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateDate != null">
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.Assess">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jun 03 15:09:44 CST 2019.
    -->
    update t_assess
    set order_id = #{orderId,jdbcType=INTEGER},
      goods_id = #{goodsId,jdbcType=INTEGER},
      parent_id = #{parentId,jdbcType=INTEGER},
      type = #{type,jdbcType=INTEGER},
      user_id = #{userId,jdbcType=INTEGER},
      content = #{content,jdbcType=VARCHAR},
      state = #{state,jdbcType=INTEGER},
      is_anonymous = #{isAnonymous,jdbcType=INTEGER},
      is_top = #{isTop,jdbcType=INTEGER},
      top_date = #{topDate,jdbcType=TIMESTAMP},
      create_date = #{createDate,jdbcType=TIMESTAMP},
      update_date = #{updateDate,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=INTEGER}
  </update>
  
  <select id="listAssessByPage" resultType="map">
			select  a1.id,a1.goods_id,a1.order_id,a1.user_id,g.goods_name,u.true_name,u.is_forbid_comment,a1.content,a4.content as  last_reply, a1.is_anonymous,a1.is_top,a1.state,a1.create_date  
			from 			(	select * from t_assess a6  where  a6.id in (
			select  min(a5.id) from  t_assess  a5  where a5.type=0  GROUP BY a5.goods_id,a5.user_id ))   a1  left join  user u on  a1.user_id=u.id
			left join t_goods  g  on   a1.goods_id=g.id
			left join  
			( 	select  * from  t_assess a3  where a3.id in	(select   max(a.id)      from   t_assess a    where  a.type=1      group by parent_id ) ) a4
			on a1.id=a4.parent_id
			where  a1.type=0  and a1.state=0
  		<if test="keyword!=null  and keyword!=''">
  			 and ( goods_name like '%${keyword}%'  or     true_name like '%${keyword}%' )
  		</if>  
  		<if test="replyStatus==0 ">
  			 and a4.content is null
  		</if>  
  		<if test="replyStatus==1 ">
  			 and a4.content is not null
  		</if>  
  			order by a1.id desc limit #{limitStart} , #{limitEnd}
  </select>
  <select id="countAssess" resultType="int">
  		select count(1) as  count  
			from 			(	select * from t_assess a6  where  a6.id in (
			select  min(a5.id) from  t_assess  a5  where a5.type=0  GROUP BY a5.goods_id,a5.user_id ))   a1  left join  user u on  a1.user_id=u.id
			left join t_goods  g  on   a1.goods_id=g.id
			left join  
			( 	select  * from  t_assess a3  where a3.id in	(select   max(a.id)      from   t_assess a    where  a.type=1      group by parent_id ) ) a4
			on a1.id=a4.parent_id
			where  a1.type=0 and a1.state=0
  		<if test="keyword!=null  and keyword!=''">
  			 and ( goods_name like '%${keyword}%'  or     true_name like '%${keyword}%' )
  		</if>  
  		<if test="replyStatus==0 ">
  			 and a4.content is null
  		</if>  
  		<if test="replyStatus==1 ">
  			 and a4.content is not null
  		</if>  
  </select>
  
  <select id="listOneAssessDetail" resultType="map">
		select  *  ,g.goods_name,user.true_name ,user.is_forbid_comment as is_forbid_comment  from (
		select  * from  t_assess  a  where  a.goods_id=#{goodsId}  and  a.user_id=#{userId} and  a.type=0
		union all 
		select  * from  t_assess  a2  where  a2.goods_id=#{goodsId}   and  a2.type=1 and  a2.parent_id in 
		(select  a3.id from  t_assess  a3  where  a3.goods_id=#{goodsId}  and  a3.user_id=#{userId} and  a3.type=0 )  )  b 
		 left join  t_goods   g   on b.goods_id=g.id
		left join user on b.user_id=user.id
		order  by   b.create_date desc
  </select>
  
	<select id="getTopAssessByGoodsId"  parameterType="java.lang.Integer" resultMap="BaseResultMap">
		select     <include refid="Base_Column_List" />
			from t_assess ass
			where ass.goods_id = #{goodsId} and ass.type = 0 and ass.state = 0
			order by if(ass.is_top = 1 ,1,0) desc , 
			ass.create_date desc limit 1 
	</select>
  
	<select id="getAssessByGoodsIdAndUserId"  resultMap="BaseResultMap">
			select  <include refid="Base_Column_List"/> 
				from t_assess ass
			where ass.goods_id = #{goodsId} 
				and ass.user_id = #{userId} and order_id = #{orderId} and type = 0 and ass.state = 0
	</select>
	
	<select id="getAssessByGoodsIdAndOrderId"  resultMap="BaseResultMap">
		select  <include refid="Base_Column_List"/> 
				from t_assess ass
			where ass.goods_id = #{goodsId} 
				and ass.order_id = #{orderId}  and (ass.state = 0 or ass.state is null) order by ass.create_date
	</select>
  
  	<select id="getAssessByGoodsId" resultMap="BaseResultMap">
  		select <include refid="Base_Column_List"/> 
  			from t_assess ass where ass.goods_id = #{goodsId}
	  		 and ass.type = 0 and state = 0
	  	order by is_top desc, ass.create_date desc
	  	<if test="limitStart != null and limitStart&gt;-1">
	      limit ${limitStart} , ${limitEnd}
	    </if>
  	</select>
  
  
  <select id="listGoodsAssessPage"  resultType="map">
  		select  user.id as user_id, a.id as assess_id,a.order_id,user.true_name,a.content,date_format(a.create_date,'%Y-%m-%d %H:%i:%S') as create_date from t_assess a   left join   user    on  a.user_id=user.id
		where a.type=0 and a.state= 0  and  a.parent_id is null and  a.goods_id=#{goodsId} order by a.create_date desc
		limit #{limitStart} , #{limitEnd}
  </select>
  <select id="countGoodsAssess"  resultType="int">
  		select  count(1) count from t_assess a   left join   user    on  a.user_id=user.id
		where a.type=0 and a.state= 0  and  a.parent_id is null and  a.goods_id=#{goodsId} 
  </select>



  <select id="listSelfGoodsAssessPage"  resultMap="BaseResultMap">
    select  <include refid="Base_Column_List"/>  from t_assess a
    where a.type=0 and a.state= 0  and a.order_id = 0  and  a.parent_id is null and  a.goods_id=#{goodsId} order by a.create_date desc
    limit #{limitStart} , #{limitEnd}
  </select>
  <select id="countSelfGoodsAssess"  resultType="int">
    select  count(1) count from t_assess a
    where a.type=0 and a.state= 0  and a.order_id = 0  and  a.parent_id is null and  a.goods_id=#{goodsId}
  </select>
</mapper>