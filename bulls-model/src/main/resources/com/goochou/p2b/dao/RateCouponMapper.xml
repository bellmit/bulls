<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goochou.p2b.dao.RateCouponMapper">
  <resultMap id="BaseResultMap" type="com.goochou.p2b.model.RateCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="type" jdbcType="INTEGER" property="type" />
    <result column="source" jdbcType="INTEGER" property="source" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="descript" jdbcType="VARCHAR" property="descript" />
    <result column="rate" jdbcType="DOUBLE" property="rate" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="use_time" jdbcType="TIMESTAMP" property="useTime" />
    <result column="expire_time" jdbcType="DATE" property="expireTime" />
    <result column="days" jdbcType="INTEGER" property="days" />
    <result column="begin_time" jdbcType="DATE" property="beginTime" />
    <result column="end_time" jdbcType="DATE" property="endTime" />
    <result column="income" jdbcType="DOUBLE" property="income" />
    <result column="investment_id" jdbcType="INTEGER" property="investmentId" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="has_dividended" jdbcType="INTEGER" property="hasDividended" />
    <result column="use_rule" jdbcType="VARCHAR" property="useRule" />
    <result column="rate_coupon_type" jdbcType="VARCHAR" property="rateCouponType" />
    <result column="admin_id" jdbcType="INTEGER" property="adminId" />
    <result column="coupon_id" jdbcType="VARCHAR" property="couponId" />
    <result column="repay_unit" jdbcType="VARCHAR" property="repayUnit" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    id, user_id, type, source, title, descript, rate, create_time, use_time, expire_time,
    days, begin_time, end_time, income, investment_id, status, has_dividended, use_rule,
    rate_coupon_type, admin_id, coupon_id, repay_unit
  </sql>
  <select id="selectByExample" parameterType="com.goochou.p2b.model.RateCouponExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from rate_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
    <if test="limitStart != null and limitStart&gt;-1">
      limit ${limitStart} , ${limitEnd}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    select
    <include refid="Base_Column_List" />
    from rate_coupon
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    delete from rate_coupon
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.goochou.p2b.model.RateCouponExample">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    delete from rate_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" keyProperty="id" parameterType="com.goochou.p2b.model.RateCoupon" useGeneratedKeys="true">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    insert into rate_coupon (id, user_id, type,
      source, title, descript,
      rate, create_time, use_time,
      expire_time, days, begin_time,
      end_time, income, investment_id,
      status, has_dividended, use_rule,
      rate_coupon_type, admin_id, coupon_id,
      repay_unit)
    values (#{id,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{type,jdbcType=INTEGER},
      #{source,jdbcType=INTEGER}, #{title,jdbcType=VARCHAR}, #{descript,jdbcType=VARCHAR},
      #{rate,jdbcType=DOUBLE}, #{createTime,jdbcType=TIMESTAMP}, #{useTime,jdbcType=TIMESTAMP},
      #{expireTime,jdbcType=DATE}, #{days,jdbcType=INTEGER}, #{beginTime,jdbcType=DATE},
      #{endTime,jdbcType=DATE}, #{income,jdbcType=DOUBLE}, #{investmentId,jdbcType=INTEGER},
      #{status,jdbcType=INTEGER}, #{hasDividended,jdbcType=INTEGER}, #{useRule,jdbcType=VARCHAR},
      #{rateCouponType,jdbcType=VARCHAR}, #{adminId,jdbcType=INTEGER}, #{couponId,jdbcType=VARCHAR},
      #{repayUnit,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.goochou.p2b.model.RateCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    insert into rate_coupon
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="type != null">
        type,
      </if>
      <if test="source != null">
        source,
      </if>
      <if test="title != null">
        title,
      </if>
      <if test="descript != null">
        descript,
      </if>
      <if test="rate != null">
        rate,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="useTime != null">
        use_time,
      </if>
      <if test="expireTime != null">
        expire_time,
      </if>
      <if test="days != null">
        days,
      </if>
      <if test="beginTime != null">
        begin_time,
      </if>
      <if test="endTime != null">
        end_time,
      </if>
      <if test="income != null">
        income,
      </if>
      <if test="investmentId != null">
        investment_id,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="hasDividended != null">
        has_dividended,
      </if>
      <if test="useRule != null">
        use_rule,
      </if>
      <if test="rateCouponType != null">
        rate_coupon_type,
      </if>
      <if test="adminId != null">
        admin_id,
      </if>
      <if test="couponId != null">
        coupon_id,
      </if>
      <if test="repayUnit != null">
        repay_unit,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        #{type,jdbcType=INTEGER},
      </if>
      <if test="source != null">
        #{source,jdbcType=INTEGER},
      </if>
      <if test="title != null">
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="descript != null">
        #{descript,jdbcType=VARCHAR},
      </if>
      <if test="rate != null">
        #{rate,jdbcType=DOUBLE},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="useTime != null">
        #{useTime,jdbcType=TIMESTAMP},
      </if>
      <if test="expireTime != null">
        #{expireTime,jdbcType=DATE},
      </if>
      <if test="days != null">
        #{days,jdbcType=INTEGER},
      </if>
      <if test="beginTime != null">
        #{beginTime,jdbcType=DATE},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=DATE},
      </if>
      <if test="income != null">
        #{income,jdbcType=DOUBLE},
      </if>
      <if test="investmentId != null">
        #{investmentId,jdbcType=INTEGER},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
      <if test="hasDividended != null">
        #{hasDividended,jdbcType=INTEGER},
      </if>
      <if test="useRule != null">
        #{useRule,jdbcType=VARCHAR},
      </if>
      <if test="rateCouponType != null">
        #{rateCouponType,jdbcType=VARCHAR},
      </if>
      <if test="adminId != null">
        #{adminId,jdbcType=INTEGER},
      </if>
      <if test="couponId != null">
        #{couponId,jdbcType=VARCHAR},
      </if>
      <if test="repayUnit != null">
        #{repayUnit,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.goochou.p2b.model.RateCouponExample" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    select count(*) from rate_coupon
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    update rate_coupon
    <set>
      <if test="record.id != null">
        id = #{record.id,jdbcType=INTEGER},
      </if>
      <if test="record.userId != null">
        user_id = #{record.userId,jdbcType=INTEGER},
      </if>
      <if test="record.type != null">
        type = #{record.type,jdbcType=INTEGER},
      </if>
      <if test="record.source != null">
        source = #{record.source,jdbcType=INTEGER},
      </if>
      <if test="record.title != null">
        title = #{record.title,jdbcType=VARCHAR},
      </if>
      <if test="record.descript != null">
        descript = #{record.descript,jdbcType=VARCHAR},
      </if>
      <if test="record.rate != null">
        rate = #{record.rate,jdbcType=DOUBLE},
      </if>
      <if test="record.createTime != null">
        create_time = #{record.createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.useTime != null">
        use_time = #{record.useTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.expireTime != null">
        expire_time = #{record.expireTime,jdbcType=DATE},
      </if>
      <if test="record.days != null">
        days = #{record.days,jdbcType=INTEGER},
      </if>
      <if test="record.beginTime != null">
        begin_time = #{record.beginTime,jdbcType=DATE},
      </if>
      <if test="record.endTime != null">
        end_time = #{record.endTime,jdbcType=DATE},
      </if>
      <if test="record.income != null">
        income = #{record.income,jdbcType=DOUBLE},
      </if>
      <if test="record.investmentId != null">
        investment_id = #{record.investmentId,jdbcType=INTEGER},
      </if>
      <if test="record.status != null">
        status = #{record.status,jdbcType=INTEGER},
      </if>
      <if test="record.hasDividended != null">
        has_dividended = #{record.hasDividended,jdbcType=INTEGER},
      </if>
      <if test="record.useRule != null">
        use_rule = #{record.useRule,jdbcType=VARCHAR},
      </if>
      <if test="record.rateCouponType != null">
        rate_coupon_type = #{record.rateCouponType,jdbcType=VARCHAR},
      </if>
      <if test="record.adminId != null">
        admin_id = #{record.adminId,jdbcType=INTEGER},
      </if>
      <if test="record.couponId != null">
        coupon_id = #{record.couponId,jdbcType=VARCHAR},
      </if>
      <if test="record.repayUnit != null">
        repay_unit = #{record.repayUnit,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    update rate_coupon
    set id = #{record.id,jdbcType=INTEGER},
      user_id = #{record.userId,jdbcType=INTEGER},
      type = #{record.type,jdbcType=INTEGER},
      source = #{record.source,jdbcType=INTEGER},
      title = #{record.title,jdbcType=VARCHAR},
      descript = #{record.descript,jdbcType=VARCHAR},
      rate = #{record.rate,jdbcType=DOUBLE},
      create_time = #{record.createTime,jdbcType=TIMESTAMP},
      use_time = #{record.useTime,jdbcType=TIMESTAMP},
      expire_time = #{record.expireTime,jdbcType=DATE},
      days = #{record.days,jdbcType=INTEGER},
      begin_time = #{record.beginTime,jdbcType=DATE},
      end_time = #{record.endTime,jdbcType=DATE},
      income = #{record.income,jdbcType=DOUBLE},
      investment_id = #{record.investmentId,jdbcType=INTEGER},
      status = #{record.status,jdbcType=INTEGER},
      has_dividended = #{record.hasDividended,jdbcType=INTEGER},
      use_rule = #{record.useRule,jdbcType=VARCHAR},
      rate_coupon_type = #{record.rateCouponType,jdbcType=VARCHAR},
      admin_id = #{record.adminId,jdbcType=INTEGER},
      coupon_id = #{record.couponId,jdbcType=VARCHAR},
      repay_unit = #{record.repayUnit,jdbcType=VARCHAR}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.goochou.p2b.model.RateCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    update rate_coupon
    <set>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="type != null">
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="source != null">
        source = #{source,jdbcType=INTEGER},
      </if>
      <if test="title != null">
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="descript != null">
        descript = #{descript,jdbcType=VARCHAR},
      </if>
      <if test="rate != null">
        rate = #{rate,jdbcType=DOUBLE},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="useTime != null">
        use_time = #{useTime,jdbcType=TIMESTAMP},
      </if>
      <if test="expireTime != null">
        expire_time = #{expireTime,jdbcType=DATE},
      </if>
      <if test="days != null">
        days = #{days,jdbcType=INTEGER},
      </if>
      <if test="beginTime != null">
        begin_time = #{beginTime,jdbcType=DATE},
      </if>
      <if test="endTime != null">
        end_time = #{endTime,jdbcType=DATE},
      </if>
      <if test="income != null">
        income = #{income,jdbcType=DOUBLE},
      </if>
      <if test="investmentId != null">
        investment_id = #{investmentId,jdbcType=INTEGER},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="hasDividended != null">
        has_dividended = #{hasDividended,jdbcType=INTEGER},
      </if>
      <if test="useRule != null">
        use_rule = #{useRule,jdbcType=VARCHAR},
      </if>
      <if test="rateCouponType != null">
        rate_coupon_type = #{rateCouponType,jdbcType=VARCHAR},
      </if>
      <if test="adminId != null">
        admin_id = #{adminId,jdbcType=INTEGER},
      </if>
      <if test="couponId != null">
        coupon_id = #{couponId,jdbcType=VARCHAR},
      </if>
      <if test="repayUnit != null">
        repay_unit = #{repayUnit,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.goochou.p2b.model.RateCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 10 10:59:11 CST 2019.
    -->
    update rate_coupon
    set user_id = #{userId,jdbcType=INTEGER},
      type = #{type,jdbcType=INTEGER},
      source = #{source,jdbcType=INTEGER},
      title = #{title,jdbcType=VARCHAR},
      descript = #{descript,jdbcType=VARCHAR},
      rate = #{rate,jdbcType=DOUBLE},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      use_time = #{useTime,jdbcType=TIMESTAMP},
      expire_time = #{expireTime,jdbcType=DATE},
      days = #{days,jdbcType=INTEGER},
      begin_time = #{beginTime,jdbcType=DATE},
      end_time = #{endTime,jdbcType=DATE},
      income = #{income,jdbcType=DOUBLE},
      investment_id = #{investmentId,jdbcType=INTEGER},
      status = #{status,jdbcType=INTEGER},
      has_dividended = #{hasDividended,jdbcType=INTEGER},
      use_rule = #{useRule,jdbcType=VARCHAR},
      rate_coupon_type = #{rateCouponType,jdbcType=VARCHAR},
      admin_id = #{adminId,jdbcType=INTEGER},
      coupon_id = #{couponId,jdbcType=VARCHAR},
      repay_unit = #{repayUnit,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>

    <select id="getNoUseMonthRateCoupon" resultType="com.goochou.p2b.model.RateCoupon">
        SELECT *
        FROM rate_coupon
        WHERE DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m') AND use_time IS NULL AND expire_time &gt;= NOW() AND user_id = #{userId}
    </select>

    <select id="getMonthSend" parameterType="int" resultType="com.goochou.p2b.model.RateCoupon">
        select * from rate_coupon where user_id = #{userId}
        <if test="source==3">
            and DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        </if>
        and source=#{source};
    </select>
    <!--  <select id="rateCouponUsingList" resultType="com.goochou.p2b.model.RateCoupon">
          SELECT * from rate_coupon where DATE_FORMAT(DATE_ADD(use_time,INTERVAL 29 DAY), '%Y-%m-%d')>=DATE_FORMAT(NOW(),'%Y-%m-%d') and type =1 and user_id= #{id}
        UNION
        SELECT * from rate_coupon where DATE_FORMAT(use_time, '%Y-%m-%d')>=DATE_FORMAT(NOW(),'%Y-%m-%d') and type =0 and user_id= #{id} order by create_time desc limit #{start},#{end}
      </select>-->
    <select id="rateCouponUsingList" resultMap="BaseResultMap">
        SELECT *
        FROM rate_coupon
        WHERE DATE_FORMAT(DATE_ADD(use_time, INTERVAL CASE WHEN days IS NULL
            THEN 29
                                                      ELSE days - 1 END DAY), '%Y-%m-%d') &gt;= DATE_FORMAT(NOW(), '%Y-%m-%d') AND type = 2 AND user_id = #{id}
        ORDER BY use_time DESC
        LIMIT #{start}, #{end}
    </select>


    <select id="countUsingRateCoupon" resultType="long">
        SELECT count(1)
        FROM rate_coupon
        WHERE DATE_FORMAT(DATE_ADD(use_time, INTERVAL CASE WHEN days IS NULL
            THEN 30
                                                      ELSE days END DAY), '%Y-%m-%d') &gt;= DATE_FORMAT(NOW(), '%Y-%m-%d') AND type = 1 AND user_id = #{id}
        UNION
        SELECT count(1)
        FROM rate_coupon
        WHERE DATE_FORMAT(DATE_ADD(use_time, INTERVAL 1 DAY), '%Y-%m-%d') &gt;= DATE_FORMAT(NOW(), '%Y-%m-%d') AND type = 0 AND user_id = #{id}
    </select>

    <select id="query" parameterType="map" resultType="map">
        select i.*,u.phone,u.username,u.true_name trueName, ua.true_name adminName from rate_coupon i join user u on i.user_id=u.id left join user_admin ua on ua.id = i.admin_id where 1=1
        <if test="keyword != null">
            and (u.username like '%${keyword}%' or u.true_name like '%${keyword}%' or u.phone like '%${keyword}%')
        </if>
        <if test="adminId != null">
            and (u.id in (select user_id from customer_list cl join user_admin ua on cl.admin_id=ua.id where (ua.parent_id=#{adminId} or cl.admin_id=#{adminId})))
        </if>
        <if test="source != null">
            and i.source=#{source}
        </if>
        <if test="days != null">
            and i.days=#{days}
        </if>
        <if test="type != null">
            and i.type=#{type}
        </if>
        <if test="startTime != null">
            and i.create_time &gt; #{startTime}
        </if>
        <if test="endTime != null">
          and i.create_time &lt; #{endTime}
        </if>
        order by i.create_time desc
        <if test="start != null and limit != null">
            limit #{start},#{limit} ;
        </if>
    </select>

    <select id="queryCount" parameterType="map" resultType="int">
        select count(*) from rate_coupon i,user u where i.user_id=u.id
        <if test="keyword != null">
            and (u.username like '%${keyword}%' or u.true_name like '%${keyword}%' or u.phone like '%${keyword}%')
        </if>
		<if test="adminId != null">
            and (u.id in (select user_id from customer_list cl join user_admin ua on cl.admin_id=ua.id where (ua.parent_id=#{adminId} or cl.admin_id=#{adminId})))
        </if>
        <if test="days != null">
            and i.days=#{days}
        </if>
        <if test="source != null">
            and i.source=#{source}
        </if>
        <if test="type != null">
            and i.type=#{type}
        </if>
        <if test="startTime != null and endTime != null">
            and i.create_time between #{startTime} and #{endTime}
        </if>
    </select>


    <select id="querySum" parameterType="map" resultType="int">
        select count(DISTINCT(i.user_id)) from rate_coupon i,user u where i.user_id=u.id
        <if test="keyword != null">
            and (u.username like '%${keyword}%' or u.true_name like '%${keyword}%' or u.phone like '%${keyword}%')
        </if>
		<if test="adminId != null">
            and (u.id in (select user_id from customer_list cl join user_admin ua on cl.admin_id=ua.id where (ua.parent_id=#{adminId} or cl.admin_id=#{adminId})))
        </if>
        <if test="days != null">
            and i.days=#{days}
        </if>
        <if test="source != null">
            and i.source=#{source}
        </if>
        <if test="type != null">
            and i.type=#{type}
        </if>
        <if test="startTime != null and endTime != null">
            and i.create_time between #{startTime} and #{endTime}
        </if>
    </select>


    <select id="getDailyCountBySource" resultType="int">
        SELECT count(id)
        FROM rate_coupon
        WHERE user_id = #{userId} AND source = #{source} AND to_days(NOW()) = to_days(create_time);
    </select>


    <insert id="addBirthdayRateCoupon" useGeneratedKeys="true">
        INSERT INTO rate_coupon (user_id, type, source, descript, rate, create_time, expire_time)
            SELECT
                u.id,
                0,
                8,
                '全民理财生日赠送活动',
                0.01,
                now(),
                date_add(curdate(), INTERVAL 1 MONTH)
            FROM user u
            WHERE date_format(u.birthday, '%m-%d') = date_format(curdate(), '%m-%d');
    </insert>

    <select id="checkBirthdayRateCoupons" resultType="int">
        SELECT count(*)
        FROM rate_coupon
        WHERE source = 8 AND date_format(create_time, '%Y-%m-%d') = curdate();
    </select>

    <select id="queryDayBirthdayUser" resultType="map">
        SELECT
            u.id,
            u.username,
            u.true_name,
            u.phone
        FROM user u
        WHERE date_format(u.birthday, '%m-%d') = date_format(curdate(), '%m-%d') AND u.phone IS NOT NULL
    </select>


    <select id="rateCouponUsingAndNoUse" resultMap="BaseResultMap">
        SELECT *
        FROM (
                 SELECT ra.*
                 FROM rate_coupon ra
                 WHERE ra.expire_time &gt;= CURDATE() AND type &lt; 3 AND use_time IS NULL AND user_id = #{id}
                 UNION
                 SELECT r.*
                 FROM rate_coupon r
                 WHERE r.use_time IS NOT NULL AND type &lt; 3 AND DATE_FORMAT(DATE_ADD(r.use_time, INTERVAL CASE WHEN r.days IS NULL
                     THEN 29
                                                                                                            ELSE r.days - 1 END DAY), '%Y-%m-%d')
                                                                  &gt;= DATE_FORMAT(CURDATE(), '%Y-%m-%d') AND user_id = #{id}
             ) a
        ORDER BY a.use_time DESC, rate DESC
        LIMIT #{start}, #{end}
    </select>


    <select id="countrateCouponUsingAndNoUse" resultType="int">
        SELECT count(a.id)
        FROM (
                 SELECT
                     use_time,
                     id,
                     rate
                 FROM rate_coupon ra
                 WHERE ra.expire_time &gt;= CURDATE() AND use_time IS NULL AND user_id = #{id}
             ) AS a
    </select>

    <select id="rateCouponNewList" parameterType="map" resultType="com.goochou.p2b.model.RateCoupon">
        SELECT *
        FROM rate_coupon
        WHERE user_id = #{userId} AND type = 3 AND status=1 and expire_time&gt;now() and use_time IS NULL
        ORDER BY status
        LIMIT #{start}, #{limit}
    </select>

    <select id="rateCouponNewCount" parameterType="int" resultType="int">
        SELECT count(*)
        FROM rate_coupon
        WHERE user_id = #{userId} AND type =3 AND status=1 and expire_time&gt;now() AND use_time IS NULL
    </select>


    <insert id="insertAndDays" keyProperty="id" parameterType="com.goochou.p2b.model.RateCoupon" useGeneratedKeys="true">
        INSERT INTO rate_coupon (id, user_id, type,
                                 source, title, descript,
                                 rate, create_time, use_time,
                                 expire_time, days, begin_time,
                                 end_time, income, investment_id,
                                 status, has_dividended, use_rule, admin_id,rate_coupon_type,coupon_id)
        VALUES (#{id,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{type,jdbcType=INTEGER},
                                        #{source,jdbcType=INTEGER}, #{title,jdbcType=VARCHAR}, #{descript,jdbcType=VARCHAR},
                                        #{rate,jdbcType=DOUBLE}, #{createTime,jdbcType=TIMESTAMP}, #{useTime,jdbcType=TIMESTAMP},
                                        #{expireTime,jdbcType=DATE}, #{days,jdbcType=INTEGER}, #{beginTime,jdbcType=TIMESTAMP},
                #{endTime,jdbcType=TIMESTAMP}, #{income,jdbcType=DOUBLE}, #{investmentId,jdbcType=INTEGER},
                #{status,jdbcType=INTEGER}, #{hasDividended,jdbcType=INTEGER}, #{useRule,jdbcType=VARCHAR}, #{adminId,jdbcType=INTEGER},#{rateCouponType,jdbcType=VARCHAR},#{couponId,jdbcType=VARCHAR})
    </insert>

    <select id="selectCouponInterestTaskList" resultMap="BaseResultMap">
        SELECT *
        FROM rate_coupon r
        WHERE type = 3 AND TO_DAYS(r.end_time) &lt;= TO_DAYS(NOW()) AND r.status = 0 AND (r.has_dividended = 0 OR r.has_dividended IS NULL) AND use_time IS NOT NULL
    </select>

    <select id="selectUseRateCouponList" parameterType="int" resultMap="BaseResultMap">
        SELECT r.*
        FROM rate_coupon r
            LEFT JOIN investment i ON r.investment_id = i.id
            LEFT JOIN project p ON p.id = i.project_id
        WHERE r.`status` = 0 AND p.id = #{projectId}
    </select>

    <insert id="insertBatch" parameterType="list">
        insert into rate_coupon ( user_id, type,source, descript,rate, create_time,expire_time, status, has_dividended, admin_id,rate_coupon_type) VALUES
        <foreach collection="list" item="coupon" separator=",">
            (#{coupon.userId},#{coupon.type},#{coupon.source},#{coupon.descript},#{coupon.rate},#{coupon.createTime},#{coupon.expireTime},#{coupon.status},#{coupon.hasDividended}, #{coupon.adminId},#{coupon.rateCouponType})
        </foreach>
    </insert>

    <select id="selectBestRateCoupon" parameterType="map" resultMap="BaseResultMap">
        SELECT * FROM rate_coupon
        WHERE STATUS=1 AND TYPE = 3
        AND use_time IS NULL AND expire_time&gt; NOW()
    AND user_id =#{userId}
    <if test="rateCouponType!=null and rateCouponType!=''">
        and rate_coupon_type= #{rateCouponType}
    </if>
        ORDER BY expire_time
    </select>

    <select id="queryExpireRateCouponAfterSomeDay" parameterType="map" resultType="map">
    	select rate amount, user_id, token from (
		select rate, user_id, token from rate_coupon h, user u where u.id = h.user_id and h.use_time IS NULL AND
		              DATE_FORMAT(h.expire_time, '%y-%m-%d') = DATE_ADD(CURDATE(), INTERVAL #{afterDay} DAY) ORDER BY rate desc ) t
		GROUP BY t.user_id
    </select>


</mapper>
